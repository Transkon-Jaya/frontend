import{u as ge,r as d,o as _e,G as ye,c as i,g as s,a as _,n as w,t as E,m as I,f as F,b as R,C as U,v as T,d as xe,h as ee,V as te,s as j,l as ke,D as le}from"./index-BhZNU2k6.js";import{V as ae,u as M,w as Ce}from"./xlsx-CibXJlkb.js";/* empty css                            */import{s as oe}from"./vue-multiselect-CqB29SHT.js";/* empty css                                                 */const Ve={class:"container-global mb-4"},Ie={key:2},Ue={key:3,class:"error"},$e={class:"table-container"},pe={key:0,class:"checkbox-container"},Ne=["checked","onClick"],Se=["onUpdate:modelValue","onInput"],De=["value","onInput"],Oe=["onUpdate:modelValue","onInput"],Ee={key:5},Fe={class:"mb-2"},Re={class:"table-container"},Te={key:0,class:"checkbox-container"},je=["checked","onClick"],Le=["onUpdate:modelValue","onInput"],ze=["value","onInput"],Be=["onUpdate:modelValue","onInput"],Me={key:5},He={__name:"BigTable",props:{settings:{type:Object,required:!0},urls:{type:Object,required:!0},fields:{type:Object,required:!0},canInsert:{type:Boolean,default:!0},canUpdate:{type:Boolean,default:!0}},setup(ne,{expose:ue}){ge();const y=ne,L=d(),c=d(),o=d(),$=d(),p=d();L.value=y.settings,c.value=y.urls,o.value=y.fields,$.value=y.canInsert,p.value=y.canUpdate;const z=L.value.size??[10,20,100];Array.isArray(o.value.toRemove)?o.value.toRemove.push("isEditing","filterable","vgt_id","originalIndex"):o.value.toRemove=["isEditing","filterable","vgt_id","originalIndex"];const r=d({data:[],dropdowns:[]}),N=d([]);let W=d([]);const S=d([]),x=d([]),h=d(!0),k=d(null);d("150px");const A=d("100px"),C=d(new Map),V=d(new Map);let K=c.value.data;if(c.value.params){const l=new URLSearchParams(c.value.params).toString();K+=`?${l}`}const se=async()=>{const l=Object.keys(c.value.dropdowns);for(const a of l){const e=c.value.dropdowns[a].url,t=c.value.dropdowns[a].valueField,u=c.value.dropdowns[a].labelField;try{const v=await j.get(e);r.value.dropdowns[u]=v.data.map(D=>D[t]??"")}catch(v){console.error(`Failed to fetch ${a} data from ${e}:`,v)}}},q=async()=>{try{h.value=!0;const l=await j.get(K);if(l.data.length>0){const a=o.value.priority||[],e=o.value.toRemove||[],t=o.value.unpriority||[],u=Object.keys(l.data[0]),v=a.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!t.includes(n)),D=t.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!v.includes(n)),ve=u.filter(n=>!v.includes(n)&&!D.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!o.value.hidden.includes(n)),he=[...v,...ve,...D];N.value=[{label:o.value.firstCol.label,field:o.value.firstCol.field,width:`${o.value.firstCol.width??80}px`,minWidth:"100px",sortable:!0,filterable:!1,editable:!1,frozen:!0,type:o.value.firstCol.type,headerClass:"custom-header"},...o.value.status?[{label:o.value.status.label??o.value.status.field.toUpperCase(),field:o.value.status.field,sortable:!1,filterable:!0,filterOptions:{enabled:!0,placeholder:"status"},editable:!1,type:"text",width:`${o.value.status.width??120}px`,minWidth:"100px",headerClass:"custom-header"}]:[],...he.map(n=>{var Q,X,Y,O,Z;const J=o.value.checkbox.includes(n),be=!J&&l.data.every(b=>{const we=b[n];return!isNaN(Number(we))}),g=(X=(Q=o.value)==null?void 0:Q.columns)==null?void 0:X.find(b=>b.column===n);return{label:n.replace(/_/g," ").toUpperCase(),field:n,sortable:!0,filterable:!0,filterOptions:{enabled:!0,placeholder:`${n}`},editable:p.value&&!((Z=(O=(Y=o.value)==null?void 0:Y.uneditable)==null?void 0:O.includes)!=null&&Z.call(O,n)),type:J?"checkbox":be?"number":"text",width:`${(g==null?void 0:g.width)??Math.max(...l.data.map(b=>String((b==null?void 0:b[n])??"").length),n.length)*z[0]+z[1]}px`,minWidth:`${(g==null?void 0:g.minWidth)??z[2]}px`,headerClass:"custome-header"}})]}W=ke(()=>N.value.map(a=>({...a,filterOptions:{enabled:!1},sortable:!1}))),r.value.data=l.data.map(a=>({...a,filterable:!0})),r.value.data=l.data.map(a=>{const e={};for(const t in a){const u=a[t];if(u==null)e[t]=u;else{const v=Number(u);e[t]=isNaN(v)?String(u):v}}return o.value.status&&o.value.status.calculate&&(e.status=o.value.status.calculate(a)),e.filterable=!0,e}),x.value=[...r.value.data],setTimeout(B,500)}catch(l){k.value="Failed to fetch data",console.error(l)}finally{h.value=!1,P()}},P=()=>{const l={};N.value.forEach(a=>{l[a.field]=o.value.checkbox.includes(a.field)?0:""}),l.id=S.value.length+1,S.value.push(l)},f=(l,a)=>{V.value.has(l.id)?V.value.get(l.id)[a]=l[a]:V.value.set(l.id,{...l})},de=async()=>{try{const l=Array.from(V.value.values());for(const a of l){const e={...a};for(const t of o.value.toRemove)delete e[t];delete e.id,o.value.date.forEach(t=>{e[t]!==null&&e[t]!==void 0&&!isNaN(Date.parse(e[t]))&&(e[t]=new Date(e[t]).toISOString().split("T")[0])}),Object.keys(e).forEach(t=>{e[t]===""&&(e[t]=null)}),await j.post(c.value.data,e),await q(),S.value=[],V.value.clear(),window.location.reload()}}catch(l){console.error("Failed to upload: ",l),alert("Failed to upload")}},m=(l,a)=>{C.value.has(l.id)?C.value.get(l.id)[a]=l[a]:C.value.set(l.id,{...l})},ie=async()=>{const l=Array.from(C.value.values()),a=[];for(const e of l)try{const t=Object.fromEntries(Object.entries(e).filter(([u])=>!o.value.exclude.includes(u)&&!o.value.toRemove.includes(u)));o.value.date.forEach(u=>{t[u]!==null&&t[u]!==void 0&&!isNaN(Date.parse(t[u]))&&(t[u]=new Date(t[u]).toISOString().split("T")[0])}),await j.put(c.value.data,t)}catch(t){console.error("Failed to update row:",e.id,t),a.push(e.id)}a.length>0?alert(`Some rows failed to save: ${a.join(", ")}`):(alert("Changes saved successfully!"),window.location.reload(),C.value.clear())},ce=()=>{const l=M.json_to_sheet(x.value),a=M.book_new();M.book_append_sheet(a,l,"Marketing Data"),Ce(a,"Filtered_Marketing_Data.xlsx")},re=l=>{x.value=l,le("Length : "+x.value.length),le("onTableFiltered : ",x.value)},B=()=>{const l=document.querySelector(".vue-good-table th:nth-child(1)");l&&(A.value=l.offsetWidth+"px"),document.documentElement.style.setProperty("--second-column-width",A.value)};ue({datas:r,loading:h,getLoading:()=>h.value}),_e(()=>{se(),q(),window.addEventListener("resize",B)}),ye(()=>{window.removeEventListener("resize",B)});const G=l=>{if(l){const[a,e]=l.split(" ");return`${a}T${e.slice(0,5)}`}return""},H=l=>{if(l){const[a,e]=l.split("T"),t=`${e}:00`;return`${a} ${t}`}return""},fe=(l,a,e)=>{a[e]=H(l.target.value),m(a,e)},me=(l,a,e)=>{a[e]=H(l.target.value),f(a,e)};return d(!1),(l,a)=>(s(),i("div",Ve,[_("h2",null,E(L.value.title),1),$.value?(s(),i("button",{key:0,onClick:de},"Upload")):w("",!0),$.value?(s(),i("button",{key:1,onClick:P},"Add New Row")):w("",!0),h.value?(s(),i("p",Ie,"Loading...")):w("",!0),k.value?(s(),i("p",Ue,E(k.value),1)):w("",!0),_("div",$e,[!h.value&&!k.value&&$.value?(s(),I(U(ae),{key:0,columns:U(W),rows:S.value,"search-options":{enabled:!1},"sort-options":{enabled:!1},"line-numbers":!1,"select-options":{enabled:!1},"pagination-options":{enabled:!1},style:{"overflow-x":"auto"}},{"table-row":F(e=>[o.value.checkbox.includes(e.column.field)?(s(),i("div",pe,[_("input",{type:"checkbox",name:"custom-checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,f(e.row,e.column.field)}},null,8,Ne)])):Object.keys(r.value.dropdowns).includes(e.column.field)?(s(),I(U(oe),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(f==null?void 0:f(e.row,e.column.field))||(m==null?void 0:m(e.row,e.column.field))],options:r.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?R((s(),i("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>f(e.row,e.column.field)},null,40,Se)),[[T,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),i("input",{key:3,type:"datetime-local",value:G(e.row[e.column.field]),onInput:t=>me(t,e.row,e.column.field)},null,40,De)):e.column.editable!==!1?R((s(),i("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>f(e.row,e.column.field)},null,40,Oe)),[[T,e.row[e.column.field]]]):(s(),i("span",Ee,E(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):w("",!0)]),_("div",Fe,[xe(te,{onClick:ce,type:"submit",color:"danger",size:"md",block:!1,class:"me-2"},{default:F(()=>a[0]||(a[0]=[ee("Export to Excel")])),_:1}),p.value?(s(),I(te,{key:0,onClick:ie,type:"submit",color:"danger",size:"md",block:!1},{default:F(()=>a[1]||(a[1]=[ee("Save Updates")])),_:1})):w("",!0)]),_("div",Re,[!h.value&&!k.value?(s(),I(U(ae),{key:0,columns:N.value,rows:r.value.data,"pagination-options":{enabled:!0,mode:"pages",perPage:10},"search-options":{enabled:!0},"sort-options":{enabled:!0},style:{"overflow-x":"auto"},onOnFiltered:re,styleClass:"vgt-table striped"},{"table-row":F(e=>[o.value.checkbox.includes(e.column.field)?(s(),i("div",Te,[_("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,m(e.row,e.column.field)}},null,8,je)])):Object.keys(r.value.dropdowns).includes(e.column.field)&&p.value?(s(),I(U(oe),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(f==null?void 0:f(e.row,e.column.field))||(m==null?void 0:m(e.row,e.column.field))],options:r.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`,noResultsText:"No matching results"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?R((s(),i("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,Le)),[[T,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),i("input",{key:3,type:"datetime-local",value:G(e.row[e.column.field]),onInput:t=>fe(t,e.row,e.column.field)},null,40,ze)):e.column.editable!==!1?R((s(),i("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,Be)),[[T,e.row[e.column.field]]]):(s(),i("span",Me,E(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):w("",!0)])]))}};export{He as _};
