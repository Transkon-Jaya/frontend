import{u as ye,r as i,o as _e,I as xe,c as d,g as s,a as C,J as b,q as g,t as F,f as $,h as A,V as L,b as K,x as O,v as W,d as ke,p as q,n as Ce}from"./index-DC_XOkuq.js";import{V as ne}from"./vue-good-table.esm-gr3o2RY4.js";/* empty css                            */import{s as ue}from"./vue-multiselect-z05IC_1O.js";import{u as G,w as $e}from"./xlsx-D1NZSDnX.js";import{l as se}from"./logger-B1IqVKgO.js";/* empty css                                                 */const pe={class:"container-global mb-4"},Ie={key:2},Ve={key:3,class:"error"},Ue={class:"table-container"},Ne={key:0,class:"checkbox-container"},Oe=["checked","onClick"],Re=["onUpdate:modelValue","onInput"],Se=["value","onInput"],De=["onUpdate:modelValue","onInput"],Ee={key:5},Te={class:"mb-2"},je={class:"table-container"},ze={key:0,class:"checkbox-container"},Be=["checked","onClick"],Fe=["onUpdate:modelValue","onInput"],Ae=["value","onInput"],Le=["onUpdate:modelValue","onInput"],Ke={key:5},Xe={__name:"BigTable",props:{settings:{type:Object,required:!0},urls:{type:Object,required:!0},fields:{type:Object,required:!0},canInsert:{type:Boolean,default:!0},canUpdate:{type:Boolean,default:!0}},setup(ie,{expose:de}){const R=ye(),p=ie,S=i(),r=i(),o=i(),D=i(),E=i();S.value=p.settings,r.value=p.urls,o.value=p.fields,D.value=p.canInsert,E.value=p.canUpdate;const M=S.value.size??[10,20,100];Array.isArray(o.value.toRemove)?o.value.toRemove.push("isEditing","filterable","vgt_id","originalIndex"):o.value.toRemove=["isEditing","filterable","vgt_id","originalIndex"];const f=i({data:[],dropdowns:[]}),T=i([]);let H=i([]);const j=i([]),y=i([]),h=i(!0),I=i(null);i("150px");const J=i("100px"),V=i(new Map),U=i(new Map);let Q=r.value.data;if(r.value.params){const l=new URLSearchParams(r.value.params).toString();Q+=`?${l}`}const ce=async()=>{const l=Object.keys(r.value.dropdowns);for(const a of l){const e=r.value.dropdowns[a].url,t=r.value.dropdowns[a].valueField,u=r.value.dropdowns[a].labelField;try{const c=await q.get(e,{headers:{Authorization:`Bearer ${R.token}`}});f.value.dropdowns[u]=c.data.map(_=>_[t]??"")}catch(c){console.error(`Failed to fetch ${a} data from ${e}:`,c)}}},X=async()=>{try{h.value=!0;const l=await q.get(Q,{headers:{Authorization:`Bearer ${R.token}`}});if(l.data.length>0){const a=o.value.priority||[],e=o.value.toRemove||[],t=o.value.unpriority||[],u=Object.keys(l.data[0]),c=a.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!t.includes(n)),_=t.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!c.includes(n)),z=u.filter(n=>!c.includes(n)&&!_.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!o.value.hidden.includes(n)),x=[...c,...z,..._];T.value=[{label:o.value.firstCol.label,field:o.value.firstCol.field,width:`${o.value.firstCol.width??80}px`,minWidth:"100px",sortable:!0,filterable:!1,editable:!1,frozen:!0,type:o.value.firstCol.type,headerClass:"custom-header"},...o.value.status?[{label:o.value.status.label??o.value.status.field.toUpperCase(),field:o.value.status.field,sortable:!1,filterable:!0,filterOptions:{enabled:!0,placeholder:"status"},editable:!1,type:"text",width:`${o.value.status.width??120}px`,minWidth:"100px",headerClass:"custom-header"}]:[],...x.map(n=>{var te,le,ae,B,oe;const N=o.value.checkbox.includes(n),be=!N&&l.data.every(w=>{const ge=w[n];return!isNaN(Number(ge))}),k=(le=(te=o.value)==null?void 0:te.columns)==null?void 0:le.find(w=>w.column===n);return{label:n.replace(/_/g," ").toUpperCase(),field:n,sortable:!0,filterable:!0,filterOptions:{enabled:!0,placeholder:`${n}`},editable:E.value&&!((oe=(B=(ae=o.value)==null?void 0:ae.uneditable)==null?void 0:B.includes)!=null&&oe.call(B,n)),type:N?"checkbox":be?"number":"text",width:`${(k==null?void 0:k.width)??Math.max(...l.data.map(w=>String((w==null?void 0:w[n])??"").length),n.length)*M[0]+M[1]}px`,minWidth:`${(k==null?void 0:k.minWidth)??M[2]}px`,headerClass:"custome-header"}})]}H=Ce(()=>T.value.map(a=>({...a,filterOptions:{enabled:!1},sortable:!1}))),f.value.data=l.data.map(a=>({...a,filterable:!0})),f.value.data=l.data.map(a=>{const e={};for(const t in a){const u=a[t];if(u==null)e[t]=u;else{const c=Number(u);e[t]=isNaN(c)?String(u):c}}return o.value.status&&o.value.status.calculate&&(e.status=o.value.status.calculate(a)),e.filterable=!0,e}),y.value=[...f.value.data],setTimeout(P,500)}catch(l){I.value="Failed to fetch data",console.error(l)}finally{h.value=!1,Y()}},Y=()=>{const l={};T.value.forEach(a=>{l[a.field]=o.value.checkbox.includes(a.field)?0:""}),l.id=j.value.length+1,j.value.push(l)},m=(l,a)=>{U.value.has(l.id)?U.value.get(l.id)[a]=l[a]:U.value.set(l.id,{...l})},re=async()=>{try{const l=Array.from(U.value.values());for(const a of l){const e={...a};for(const t of o.value.toRemove)delete e[t];delete e.id,o.value.date.forEach(t=>{e[t]!==null&&e[t]!==void 0&&!isNaN(Date.parse(e[t]))&&(e[t]=new Date(e[t]).toISOString().split("T")[0])}),Object.keys(e).forEach(t=>{e[t]===""&&(e[t]=null)}),await q.post(r.value.data,e,{headers:{Authorization:`Bearer ${R.token}`}}),await X(),j.value=[],U.value.clear(),window.location.reload()}}catch(l){console.error("Failed to upload: ",l),alert("Failed to upload")}},v=(l,a)=>{V.value.has(l.id)?V.value.get(l.id)[a]=l[a]:V.value.set(l.id,{...l})},fe=async()=>{const l=Array.from(V.value.values()),a=[];for(const e of l)try{const t=Object.fromEntries(Object.entries(e).filter(([u])=>!o.value.exclude.includes(u)&&!o.value.toRemove.includes(u)));o.value.date.forEach(u=>{t[u]!==null&&t[u]!==void 0&&!isNaN(Date.parse(t[u]))&&(t[u]=new Date(t[u]).toISOString().split("T")[0])}),await q.put(r.value.data,t,{headers:{Authorization:`Bearer ${R.token}`}})}catch(t){console.error("Failed to update row:",e.id,t),a.push(e.id)}a.length>0?alert(`Some rows failed to save: ${a.join(", ")}`):(alert("Changes saved successfully!"),window.location.reload(),V.value.clear())},me=()=>{const l=o.value.priority,a=o.value.toRemove,t=Object.keys(y.value[0]).filter(x=>!l.includes(x)&&!a.includes(x)),u=[...l,...t],c=y.value.map(x=>{const n={};return u.forEach(N=>{n[N]=x[N]}),n}),_=G.json_to_sheet(c,{header:u}),z=G.book_new();G.book_append_sheet(z,_,"Marketing Data"),$e(z,`${S.value.export}.xlsx`)},ve=l=>{y.value=l,se("Length : "+y.value.length),se("onTableFiltered : ",y.value)},P=()=>{const l=document.querySelector(".vue-good-table th:nth-child(1)");l&&(J.value=l.offsetWidth+"px"),document.documentElement.style.setProperty("--second-column-width",J.value)};de({datas:f,loading:h,getLoading:()=>h.value}),_e(()=>{ce(),X(),window.addEventListener("resize",P)}),xe(()=>{window.removeEventListener("resize",P)});const Z=l=>{if(l){const[a,e]=l.split(" ");return`${a}T${e.slice(0,5)}`}return""},ee=l=>{if(l){const[a,e]=l.split("T"),t=`${e}:00`;return`${a} ${t}`}return""},he=(l,a,e)=>{a[e]=ee(l.target.value),v(a,e)},we=(l,a,e)=>{a[e]=ee(l.target.value),m(a,e)};return i(!1),(l,a)=>(s(),d("div",pe,[C("h2",null,F(S.value.title),1),D.value?(s(),b(L,{key:0,onClick:re,color:"danger",class:"me-2"},{default:$(()=>a[0]||(a[0]=[A("Upload")])),_:1})):g("",!0),D.value?(s(),b(L,{key:1,onClick:Y,color:"danger"},{default:$(()=>a[1]||(a[1]=[A("Add New Row")])),_:1})):g("",!0),h.value?(s(),d("p",Ie,"Loading...")):g("",!0),I.value?(s(),d("p",Ve,F(I.value),1)):g("",!0),C("div",Ue,[!h.value&&!I.value&&D.value?(s(),b(O(ne),{key:0,columns:O(H),rows:j.value,"search-options":{enabled:!1},"sort-options":{enabled:!1},"line-numbers":!1,"select-options":{enabled:!1},"pagination-options":{enabled:!1},style:{"overflow-x":"auto"}},{"table-row":$(e=>[o.value.checkbox.includes(e.column.field)?(s(),d("div",Ne,[C("input",{type:"checkbox",name:"custom-checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,m(e.row,e.column.field)}},null,8,Oe)])):Object.keys(f.value.dropdowns).includes(e.column.field)?(s(),b(O(ue),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(m==null?void 0:m(e.row,e.column.field))||(v==null?void 0:v(e.row,e.column.field))],options:f.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?K((s(),d("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,Re)),[[W,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),d("input",{key:3,type:"datetime-local",value:Z(e.row[e.column.field]),onInput:t=>we(t,e.row,e.column.field)},null,40,Se)):e.column.editable!==!1?K((s(),d("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,De)),[[W,e.row[e.column.field]]]):(s(),d("span",Ee,F(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):g("",!0)]),C("div",Te,[ke(L,{onClick:me,type:"submit",color:"danger",size:"md",block:!1,class:"me-2"},{default:$(()=>a[2]||(a[2]=[A("Export to Excel")])),_:1}),E.value?(s(),b(L,{key:0,onClick:fe,type:"submit",color:"danger",size:"md",block:!1},{default:$(()=>a[3]||(a[3]=[A("Save Updates")])),_:1})):g("",!0)]),C("div",je,[!h.value&&!I.value?(s(),b(O(ne),{key:0,columns:T.value,rows:f.value.data,"pagination-options":{enabled:!0,mode:"pages",perPage:10},"search-options":{enabled:!0},"sort-options":{enabled:!0},style:{"overflow-x":"auto"},onOnFiltered:ve,styleClass:"vgt-table striped"},{"table-row":$(e=>[o.value.checkbox.includes(e.column.field)?(s(),d("div",ze,[C("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,v(e.row,e.column.field)}},null,8,Be)])):Object.keys(f.value.dropdowns).includes(e.column.field)&&E.value?(s(),b(O(ue),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(m==null?void 0:m(e.row,e.column.field))||(v==null?void 0:v(e.row,e.column.field))],options:f.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`,noResultsText:"No matching results"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?K((s(),d("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>v(e.row,e.column.field)},null,40,Fe)),[[W,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),d("input",{key:3,type:"datetime-local",value:Z(e.row[e.column.field]),onInput:t=>he(t,e.row,e.column.field)},null,40,Ae)):e.column.editable!==!1?K((s(),d("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>v(e.row,e.column.field)},null,40,Le)),[[W,e.row[e.column.field]]]):(s(),d("span",Ke,F(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):g("",!0)])]))}};export{Xe as _};
