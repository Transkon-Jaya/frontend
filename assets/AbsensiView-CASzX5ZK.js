import{_ as ee,c as u,p as S,g as d,a,q as V,t as m,u as ae,r as c,m as P,o as te,d as k,f as C,i as z,s as A,A as N,P as ne,h as J}from"./index-BmQnQwVr.js";const oe={props:{imageSrc:{type:String,required:!0},imageTitle:{type:String,default:"Image Preview"},showModal:{type:Boolean,default:!1}},methods:{closeModal(){this.$emit("close")},handleKeydown(I){I.key==="Escape"&&this.closeModal()}},mounted(){window.addEventListener("keydown",this.handleKeydown)},beforeUnmount(){window.removeEventListener("keydown",this.handleKeydown)}},se={class:"modal-dialog modal-dialog-centered",role:"document"},le={class:"modal-header"},ie={class:"modal-title",id:"imageModalLabel"},re={class:"modal-body"},ce=["src"];function ue(I,r,l,b,o,p){return l.showModal?(d(),u("div",{key:0,class:"modal fade show",tabindex:"-1",role:"dialog","aria-labelledby":"imageModalLabel",style:{display:"block"},"aria-hidden":"false",onClick:r[2]||(r[2]=V((...y)=>p.closeModal&&p.closeModal(...y),["self"]))},[a("div",se,[a("div",{class:"modal-content",onClick:r[1]||(r[1]=V(()=>{},["stop"]))},[a("div",le,[a("h5",ie,m(l.imageTitle),1),a("button",{type:"button",class:"close",onClick:r[0]||(r[0]=(...y)=>p.closeModal&&p.closeModal(...y)),"aria-label":"Close"},r[3]||(r[3]=[a("span",{"aria-hidden":"true"},"×",-1)]))]),a("div",re,[a("img",{src:l.imageSrc,alt:"Image Preview",class:"img-fluid"},null,8,ce)])])])])):S("",!0)}const R=ee(oe,[["render",ue],["__scopeId","data-v-b06dafc1"]]),de={class:"app-container"},ve={class:"main-content"},me={class:"container-global attendance-card"},pe={class:"form-group"},ge={key:0,id:"location",class:"form-control-plaintext"},he={key:1,class:"form-control-plaintext text-muted"},fe={key:0,class:"mb-4"},_e={key:1,class:"mb-4"},be={class:"action-group"},ye={key:0},we={key:1},Me={key:2},ke={key:3},Se={key:2,class:"confirmation-message"},$e={class:"container-global announcement-card"},De={class:"announcement-content"},Ae=["src"],Ie={class:"announcement-text"},xe={class:"container-global info-section-edit"},Le={class:"info-card"},Pe={class:"info-content"},Ce={class:"info-row"},Ne={class:"info-value"},Ue={class:"info-row"},Be={class:"info-value"},Ee={class:"info-row"},Oe={key:0,class:"info-value"},Te={key:1,class:"info-value text-muted"},Fe={class:"info-row"},Ge={class:"info-value"},Ve=["src"],ze=12,Re={__name:"AbsensiView",setup(I){const r=ae();c(null);const l=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],b=c({ipv4:l[0],ipv6:l[0]}),o=c({lat:l[0],lon:l[0]});c({city:l[0],country:l[0],lat:"",lon:""});const p=c("");c("");const y=c(!1),_=c(""),g=c([]),v=c([]),x=c(!0),$=c(!1),L=c(""),U=P(()=>![o.value.lat,o.value.lon,b.value.ipv4].some(t=>l.includes(t))),B=P(()=>{var t,e;return(((t=_.value)==null?void 0:t.distance)??99999)>((e=_.value)==null?void 0:e.maxDistance)}),h=P(()=>{const t=v.value[0];if(!t)return"IN";const e=t.hour_in?new Date(t.hour_in):null,n=new Date,i=e&&e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate(),s=e?(n-e)/(1e3*60*60):null;return!i&&(t.hour_out||s>=16)?"IN":!t.hour_out||t.hour_out==="00:00:00"?"OUT":"DONE"}),M=c({photo:null,description:""}),H=async()=>{const t=await A.get(`${N}/tools/memo`);console.log(t),M.value.photo=`${ne}/memo/${t.data[0].photo}`,M.value.description=t.data[0].description,console.log(M.value)},K=async()=>{const t=await fetch(`${r.apiBaseUrl}/absensi-status?username=${r.username}`);v.value=await t.json(),v.value.length>0&&(v.value[0].foto_in=`${r.baseUrl}/uploads/absensi/${v.value[0].foto_in}`,v.value[0].foto_out=`${r.baseUrl}/uploads/absensi/${v.value[0].foto_out}`),x.value=!1},q=()=>new Promise(t=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{o.value.lat=e.coords.latitude.toFixed(6),o.value.lon=e.coords.longitude.toFixed(6),p.value=`https://static-maps.yandex.ru/1.x/?lang=en-US&ll=${o.value.lon},${o.value.lat}&size=450,300&z=${ze}&l=map&pt=${o.value.lon},${o.value.lat},pm2rdm`,t(!0)},e=>{console.warn("❌ Geolocation permission denied or error:",e.message),o.value.lat=l[1],o.value.lon=l[1],t(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("❌ Unexpected GPS error:",e),o.value.lat=l[2],o.value.lon=l[2],t(!1)}else o.value.lat=l[2],o.value.lon=l[2],t(!1)});function j(t,e,n,i){const f=(n-t)*Math.PI/180,w=(i-e)*Math.PI/180,D=Math.sin(f/2)**2+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(w/2)**2,G=6371*(2*Math.atan2(Math.sqrt(D),Math.sqrt(1-D)))*1e3;return isNaN(G)?0:G.toFixed(2)}const Y=async()=>{const t=await A.get(`${N}/hr-lokasi`,{headers:{Authorization:`Bearer ${r.token}`}});g.value=t.data.map(e=>{const n=e.latitude??null,i=e.longitude??null,s=e.maxDistance!=null?parseInt(e.maxDistance,10):null,f=n!==null&&i!==null&&o.value.lat&&o.value.lon?j(o.value.lat,o.value.lon,n,i):1/0;return{nama:e.nama??"",lat:n,lon:i,distance:f,maxDistance:s}}),g.value.sort((e,n)=>e.distance-n.distance),g.value.length>0&&(_.value=g.value[0])},Z=async()=>{try{const t=await A.get(`${N}/ip`,{headers:{Authorization:`Bearer ${r.token}`}});b.value.ipv4=t.data.ip}catch(t){console.error("Error fetching IP:",t),b.value.ipv4=l[2]}},E=t=>{L.value=t,$.value=!0},O=()=>{$.value=!1},W=()=>{if(!_.value){alert("Silakan pilih lokasi absen terlebih dahulu!");return}document.getElementById("cameraInput").click()},Q=()=>{const t=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,n=e.match(/\(([^)]+)\)/);let i=n?n[1]:`?${e}`;return i.length>250&&(i=i.substring(0,250)),{dimension:t,device:i}},X=async t=>{const e=t.target.files[0];if(e)try{const{dimension:n,device:i}=Q(),s=new FormData;s.append("foto",e),s.append("id",h.value=="IN"?null:v.value[0].id),s.append("status",h.value),s.append("username",r.username),s.append("lokasi",_.value.nama),s.append("jarak",_.value.distance),s.append("long",o.value.lon),s.append("lang",o.value.lat),s.append("ip",b.value.ipv4),s.append("dim",n),s.append("device",i);const w=(await A.post("https://www.transkon-rent.com/api/absensi",s,{headers:{Authorization:`Bearer ${r.token}`,"Content-Type":"multipart/form-data"}})).data;w.status==="success"?(y.value=!0,window.location.reload()):console.error("Attendance failed:",w.message)}catch(n){console.error("Upload error:",n)}};te(async()=>{try{console.log("1. Meminta izin GPS..."),await q()||console.warn("⚠️ Lokasi gagal dimuat. Melanjutkan tanpa GPS..."),await Promise.all([H(),Y(),Z(),K()]),console.log("✅ Semua data berhasil dimuat.")}catch(t){console.error("💥 Unhandled error in onMounted:",t)}});function T(t){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],n=new Date(t),i=n.getDate(),s=e[n.getMonth()],f=n.getFullYear(),w=String(n.getHours()).padStart(2,"0"),D=String(n.getMinutes()).padStart(2,"0"),F=String(n.getSeconds()).padStart(2,"0");return`${i} ${s} ${f} ${w}:${D}:${F}`}return(t,e)=>{var s;const n=z("VButton"),i=z("Button");return d(),u("div",de,[a("main",ve,[e[12]||(e[12]=a("h1",{class:"app-title"},"Absensi Karyawan",-1)),e[13]||(e[13]=a("p",{class:"app-subtitle"},null,-1)),a("div",me,[a("div",pe,[g.value.length>0?(d(),u("p",ge,m(g.value[0].nama),1)):(d(),u("p",he,"Loading location..."))]),h.value==="OUT"||h.value==="DONE"?(d(),u("div",fe,[a("div",null,m(T(v.value[0].hour_in)),1),k(n,{onClick:e[0]||(e[0]=f=>E(v.value[0].foto_in)),class:"btn btn-danger"},{default:C(()=>e[2]||(e[2]=[J("Photo In")])),_:1}),k(R,{imageSrc:L.value,showModal:$.value,onClose:O},null,8,["imageSrc","showModal"])])):S("",!0),h.value==="DONE"?(d(),u("div",_e,[a("div",null,m(T((s=v.value[0])==null?void 0:s.hour_out)),1),k(n,{onClick:e[1]||(e[1]=f=>E(v.value[0].foto_out)),class:"btn btn-danger"},{default:C(()=>e[3]||(e[3]=[J("Photo Out")])),_:1}),k(R,{imageSrc:L.value,showModal:$.value,onClose:O},null,8,["imageSrc","showModal"])])):S("",!0),a("div",be,[a("input",{type:"file",accept:"image/*",capture:"environment",onChange:X,id:"cameraInput",style:{display:"none"}},null,32),k(i,{onClick:W,class:"primary-btn",disabled:!_.value||h.value==="DONE"||x.value||!U.value||B.value},{default:C(()=>[e[4]||(e[4]=a("i",{class:"fa-solid fa-camera"},null,-1)),x.value?(d(),u("span",ye,"Loading...")):U.value?B.value?(d(),u("span",Me,"Anda Diluar Zona Absensi")):(d(),u("span",ke,m(h.value==="DONE"?"Sudah Absen":h.value==="OUT"?"Absen OUT":"Absen IN"),1)):(d(),u("span",we,"Gagal Memuat"))]),_:1},8,["disabled"])]),y.value?(d(),u("div",Se,e[5]||(e[5]=[a("i",{class:"fa-solid fa-check-circle success-icon"},null,-1),a("span",null,"Absensi berhasil direkam!",-1)]))):S("",!0)]),a("div",$e,[e[6]||(e[6]=a("div",{class:"announcement-header"},[a("i",{class:"fa-solid fa-bullhorn announcement-icon"}),a("h3",null,"TRJA Memo")],-1)),a("div",De,[a("img",{src:M.value.photo,alt:"TRJA Memo",class:"announcement-image"},null,8,Ae),a("p",Ie,m(M.value.description),1)])]),a("div",xe,[a("div",Le,[e[11]||(e[11]=a("div",{class:"info-header"},[a("i",{class:"fa-solid fa-map-marker-alt"}),a("h4",null,"Lokasi GPS Anda")],-1)),a("div",Pe,[a("div",Ce,[e[7]||(e[7]=a("span",{class:"info-label"},"Latitude:",-1)),a("span",Ne,m(o.value.lat),1)]),a("div",Ue,[e[8]||(e[8]=a("span",{class:"info-label"},"Longitude:",-1)),a("span",Be,m(o.value.lon),1)]),a("div",Ee,[e[9]||(e[9]=a("span",{class:"info-label"},"Jarak:",-1)),g.value.length>0?(d(),u("span",Oe,m(g.value[0].distance+" Meter"),1)):(d(),u("span",Te," Menghitung Jarak.. "))]),a("div",Fe,[e[10]||(e[10]=a("span",{class:"info-label"},"IPv4:",-1)),a("span",Ge,m(b.value.ipv4),1)]),p.value?(d(),u("img",{key:0,src:p.value,alt:"GPS Map",class:"map-image"},null,8,Ve)):S("",!0)])])])])])}}};export{Re as default};
