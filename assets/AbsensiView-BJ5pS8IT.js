import{_ as Q,c as u,n as k,g as c,a as t,p as G,t as p,u as X,r as d,l as x,o as ee,q as ae,d as M,f as L,i as T,s as P,A as V,h as z}from"./index-DLx-p2UZ.js";const te="/office/assets/tes-CBUbhp8o.jpg",ne={props:{imageSrc:{type:String,required:!0},imageTitle:{type:String,default:"Image Preview"},showModal:{type:Boolean,default:!1}},methods:{closeModal(){this.$emit("close")},handleKeydown(D){D.key==="Escape"&&this.closeModal()}},mounted(){window.addEventListener("keydown",this.handleKeydown)},beforeUnmount(){window.removeEventListener("keydown",this.handleKeydown)}},se={class:"modal-dialog modal-dialog-centered",role:"document"},oe={class:"modal-header"},le={class:"modal-title",id:"imageModalLabel"},ie={class:"modal-body"},re=["src"];function ue(D,r,l,b,s,m){return l.showModal?(c(),u("div",{key:0,class:"modal fade show",tabindex:"-1",role:"dialog","aria-labelledby":"imageModalLabel",style:{display:"block"},"aria-hidden":"false",onClick:r[2]||(r[2]=G((...y)=>m.closeModal&&m.closeModal(...y),["self"]))},[t("div",se,[t("div",{class:"modal-content",onClick:r[1]||(r[1]=G(()=>{},["stop"]))},[t("div",oe,[t("h5",le,p(l.imageTitle),1),t("button",{type:"button",class:"close",onClick:r[0]||(r[0]=(...y)=>m.closeModal&&m.closeModal(...y)),"aria-label":"Close"},r[3]||(r[3]=[t("span",{"aria-hidden":"true"},"×",-1)]))]),t("div",ie,[t("img",{src:l.imageSrc,alt:"Image Preview",class:"img-fluid"},null,8,re)])])])])):k("",!0)}const J=Q(ne,[["render",ue],["__scopeId","data-v-b06dafc1"]]),ce={class:"app-container"},de={class:"main-content"},ve={class:"container-global attendance-card"},pe={class:"form-group"},me={key:0,id:"location",class:"form-control-plaintext"},ge={key:1,class:"form-control-plaintext text-muted"},fe={key:0,class:"mb-4"},he={key:1,class:"mb-4"},_e={class:"action-group"},be={key:0},ye={key:1},we={key:2},Me={key:3},ke={key:2,class:"confirmation-message"},Se={class:"container-global info-section-edit"},$e={class:"info-card"},De={class:"info-content"},Ie={class:"info-row"},Ae={class:"info-value"},xe={class:"info-row"},Le={class:"info-value"},Pe={class:"info-row"},Ce={key:0,class:"info-value"},Ne={key:1,class:"info-value text-muted"},Ue={class:"info-row"},Be={class:"info-value"},Ee=["src"],Oe=12,Ge={__name:"AbsensiView",setup(D){const r=X();d(null);const l=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],b=d({ipv4:l[0],ipv6:l[0]}),s=d({lat:l[0],lon:l[0]});d({city:l[0],country:l[0],lat:"",lon:""});const m=d("");d("");const y=d(!1),_=d(""),g=d([]),v=d([]),I=d(!0),S=d(!1),A=d(""),C=x(()=>![s.value.lat,s.value.lon,b.value.ipv4].some(a=>l.includes(a))),N=x(()=>{var a,e;return(((a=_.value)==null?void 0:a.distance)??99999)>((e=_.value)==null?void 0:e.maxDistance)}),f=x(()=>{const a=v.value[0];if(!a)return"IN";const e=a.hour_in?new Date(a.hour_in):null,n=new Date,i=e&&e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate(),o=e?(n-e)/(1e3*60*60):null;return!i&&(a.hour_out||o>=16)?"IN":!a.hour_out||a.hour_out==="00:00:00"?"OUT":"DONE"}),K=async()=>{const a=await fetch(`${r.apiBaseUrl}/absensi-status?username=${r.username}`);v.value=await a.json(),v.value.length>0&&(v.value[0].foto_in=`${r.baseUrl}/uploads/absensi/${v.value[0].foto_in}`,v.value[0].foto_out=`${r.baseUrl}/uploads/absensi/${v.value[0].foto_out}`),I.value=!1},R=()=>new Promise(a=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{s.value.lat=e.coords.latitude.toFixed(6),s.value.lon=e.coords.longitude.toFixed(6),m.value=`https://static-maps.yandex.ru/1.x/?lang=en-US&ll=${s.value.lon},${s.value.lat}&size=450,300&z=${Oe}&l=map&pt=${s.value.lon},${s.value.lat},pm2rdm`,a(!0)},e=>{console.warn("❌ Geolocation permission denied or error:",e.message),s.value.lat=l[1],s.value.lon=l[1],a(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("❌ Unexpected GPS error:",e),s.value.lat=l[2],s.value.lon=l[2],a(!1)}else s.value.lat=l[2],s.value.lon=l[2],a(!1)});function j(a,e,n,i){const h=(n-a)*Math.PI/180,w=(i-e)*Math.PI/180,$=Math.sin(h/2)**2+Math.cos(a*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(w/2)**2,F=6371*(2*Math.atan2(Math.sqrt($),Math.sqrt(1-$)))*1e3;return isNaN(F)?0:F.toFixed(2)}const q=async()=>{const a=await P.get(`${V}/hr-lokasi`,{headers:{Authorization:`Bearer ${r.token}`}});g.value=a.data.map(e=>{const n=e.latitude??null,i=e.longitude??null,o=e.maxDistance!=null?parseInt(e.maxDistance,10):null,h=n!==null&&i!==null&&s.value.lat&&s.value.lon?j(s.value.lat,s.value.lon,n,i):1/0;return{nama:e.nama??"",lat:n,lon:i,distance:h,maxDistance:o}}),g.value.sort((e,n)=>e.distance-n.distance),g.value.length>0&&(_.value=g.value[0])},H=async()=>{try{const a=await P.get(`${V}/ip`,{headers:{Authorization:`Bearer ${r.token}`}});b.value.ipv4=a.data.ip}catch(a){console.error("Error fetching IP:",a),b.value.ipv4=l[2]}},U=a=>{A.value=a,S.value=!0},B=()=>{S.value=!1},Y=()=>{if(!_.value){alert("Silakan pilih lokasi absen terlebih dahulu!");return}document.getElementById("cameraInput").click()},Z=()=>{const a=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,n=e.match(/\(([^)]+)\)/);let i=n?n[1]:`?${e}`;return i.length>250&&(i=i.substring(0,250)),{dimension:a,device:i}},W=async a=>{const e=a.target.files[0];if(e)try{const{dimension:n,device:i}=Z(),o=new FormData;o.append("foto",e),o.append("id",f.value=="IN"?null:v.value[0].id),o.append("status",f.value),o.append("username",r.username),o.append("lokasi",_.value.nama),o.append("jarak",_.value.distance),o.append("long",s.value.lon),o.append("lang",s.value.lat),o.append("ip",b.value.ipv4),o.append("dim",n),o.append("device",i);const w=(await P.post("https://www.transkon-rent.com/api/absensi",o,{headers:{Authorization:`Bearer ${r.token}`,"Content-Type":"multipart/form-data"}})).data;w.status==="success"?(y.value=!0,window.location.reload()):console.error("Attendance failed:",w.message)}catch(n){console.error("Upload error:",n)}};ee(async()=>{try{console.log("1. Meminta izin GPS..."),await R()||console.warn("⚠️ Lokasi gagal dimuat. Melanjutkan tanpa GPS..."),await Promise.all([q(),H(),K()]),console.log("✅ Semua data berhasil dimuat.")}catch(a){console.error("💥 Unhandled error in onMounted:",a)}});function E(a){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],n=new Date(a),i=n.getDate(),o=e[n.getMonth()],h=n.getFullYear(),w=String(n.getHours()).padStart(2,"0"),$=String(n.getMinutes()).padStart(2,"0"),O=String(n.getSeconds()).padStart(2,"0");return`${i} ${o} ${h} ${w}:${$}:${O}`}return(a,e)=>{var o;const n=T("VButton"),i=T("Button");return c(),u("div",ce,[t("main",de,[e[11]||(e[11]=t("h1",{class:"app-title"},"Absensi Karyawan",-1)),e[12]||(e[12]=t("p",{class:"app-subtitle"},null,-1)),t("div",ve,[t("div",pe,[g.value.length>0?(c(),u("p",me,p(g.value[0].nama),1)):(c(),u("p",ge,"Loading location..."))]),f.value==="OUT"||f.value==="DONE"?(c(),u("div",fe,[t("div",null,p(E(v.value[0].hour_in)),1),M(n,{onClick:e[0]||(e[0]=h=>U(v.value[0].foto_in)),class:"btn btn-danger"},{default:L(()=>e[2]||(e[2]=[z("Photo In")])),_:1}),M(J,{imageSrc:A.value,showModal:S.value,onClose:B},null,8,["imageSrc","showModal"])])):k("",!0),f.value==="DONE"?(c(),u("div",he,[t("div",null,p(E((o=v.value[0])==null?void 0:o.hour_out)),1),M(n,{onClick:e[1]||(e[1]=h=>U(v.value[0].foto_out)),class:"btn btn-danger"},{default:L(()=>e[3]||(e[3]=[z("Photo Out")])),_:1}),M(J,{imageSrc:A.value,showModal:S.value,onClose:B},null,8,["imageSrc","showModal"])])):k("",!0),t("div",_e,[t("input",{type:"file",accept:"image/*",capture:"environment",onChange:W,id:"cameraInput",style:{display:"none"}},null,32),M(i,{onClick:Y,class:"primary-btn",disabled:!_.value||f.value==="DONE"||I.value||!C.value||N.value},{default:L(()=>[e[4]||(e[4]=t("i",{class:"fa-solid fa-camera"},null,-1)),I.value?(c(),u("span",be,"Loading...")):C.value?N.value?(c(),u("span",we,"Anda Diluar Zona Absensi")):(c(),u("span",Me,p(f.value==="DONE"?"Sudah Absen":f.value==="OUT"?"Absen OUT":"Absen IN"),1)):(c(),u("span",ye,"Gagal Memuat"))]),_:1},8,["disabled"])]),y.value?(c(),u("div",ke,e[5]||(e[5]=[t("i",{class:"fa-solid fa-check-circle success-icon"},null,-1),t("span",null,"Absensi berhasil direkam!",-1)]))):k("",!0)]),e[13]||(e[13]=ae('<div class="container-global announcement-card"><div class="announcement-header"><i class="fa-solid fa-bullhorn announcement-icon"></i><h3>TRJA Memo</h3></div><div class="announcement-content"><img src="'+te+'" alt="Gambar Lebaran" class="announcement-image"><p class="announcement-text"></p></div></div>',1)),t("div",Se,[t("div",$e,[e[10]||(e[10]=t("div",{class:"info-header"},[t("i",{class:"fa-solid fa-map-marker-alt"}),t("h4",null,"Lokasi GPS Anda")],-1)),t("div",De,[t("div",Ie,[e[6]||(e[6]=t("span",{class:"info-label"},"Latitude:",-1)),t("span",Ae,p(s.value.lat),1)]),t("div",xe,[e[7]||(e[7]=t("span",{class:"info-label"},"Longitude:",-1)),t("span",Le,p(s.value.lon),1)]),t("div",Pe,[e[8]||(e[8]=t("span",{class:"info-label"},"Jarak:",-1)),g.value.length>0?(c(),u("span",Ce,p(g.value[0].distance+" Meter"),1)):(c(),u("span",Ne," Menghitung Jarak.. "))]),t("div",Ue,[e[9]||(e[9]=t("span",{class:"info-label"},"IPv4:",-1)),t("span",Be,p(b.value.ipv4),1)]),m.value?(c(),u("img",{key:0,src:m.value,alt:"GPS Map",class:"map-image"},null,8,Ee)):k("",!0)])])])])])}}};export{Ge as default};
