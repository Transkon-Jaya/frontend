import{u as ye,r as d,o as _e,D as xe,c as i,g as s,a as _,m as b,n as g,t as F,f as x,h as R,V as T,b as z,C as U,v as B,d as ke,s as j,l as Ce}from"./index-DLx-p2UZ.js";import{V as ae,u as K,w as $e}from"./xlsx-V7VM0qA_.js";/* empty css                            */import{s as oe}from"./vue-multiselect-B_mn9QBd.js";import{l as ne}from"./logger-B1IqVKgO.js";/* empty css                                                 */const Ve={class:"container-global mb-4"},Ie={key:2},Ue={key:3,class:"error"},pe={class:"table-container"},Ne={key:0,class:"checkbox-container"},De=["checked","onClick"],Se=["onUpdate:modelValue","onInput"],Oe=["value","onInput"],Ee=["onUpdate:modelValue","onInput"],Fe={key:5},Re={class:"mb-2"},Te={class:"table-container"},ze={key:0,class:"checkbox-container"},Be=["checked","onClick"],je=["onUpdate:modelValue","onInput"],Ae=["value","onInput"],Le=["onUpdate:modelValue","onInput"],Me={key:5},Qe={__name:"BigTable",props:{settings:{type:Object,required:!0},urls:{type:Object,required:!0},fields:{type:Object,required:!0},canInsert:{type:Boolean,default:!0},canUpdate:{type:Boolean,default:!0}},setup(ue,{expose:se}){const A=ye(),k=ue,L=d(),c=d(),o=d(),p=d(),N=d();L.value=k.settings,c.value=k.urls,o.value=k.fields,p.value=k.canInsert,N.value=k.canUpdate;const M=L.value.size??[10,20,100];Array.isArray(o.value.toRemove)?o.value.toRemove.push("isEditing","filterable","vgt_id","originalIndex"):o.value.toRemove=["isEditing","filterable","vgt_id","originalIndex"];const r=d({data:[],dropdowns:[]}),D=d([]);let q=d([]);const S=d([]),C=d([]),h=d(!0),$=d(null);d("150px");const P=d("100px"),V=d(new Map),I=d(new Map);let G=c.value.data;if(c.value.params){const l=new URLSearchParams(c.value.params).toString();G+=`?${l}`}const de=async()=>{const l=Object.keys(c.value.dropdowns);for(const a of l){const e=c.value.dropdowns[a].url,t=c.value.dropdowns[a].valueField,u=c.value.dropdowns[a].labelField;try{const v=await j.get(e,{headers:{Authorization:`Bearer ${A.token}`}});r.value.dropdowns[u]=v.data.map(O=>O[t]??"")}catch(v){console.error(`Failed to fetch ${a} data from ${e}:`,v)}}},H=async()=>{try{h.value=!0;const l=await j.get(G,{headers:{Authorization:`Bearer ${A.token}`}});if(l.data.length>0){const a=o.value.priority||[],e=o.value.toRemove||[],t=o.value.unpriority||[],u=Object.keys(l.data[0]),v=a.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!t.includes(n)),O=t.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!v.includes(n)),he=u.filter(n=>!v.includes(n)&&!O.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!o.value.hidden.includes(n)),we=[...v,...he,...O];D.value=[{label:o.value.firstCol.label,field:o.value.firstCol.field,width:`${o.value.firstCol.width??80}px`,minWidth:"100px",sortable:!0,filterable:!1,editable:!1,frozen:!0,type:o.value.firstCol.type,headerClass:"custom-header"},...o.value.status?[{label:o.value.status.label??o.value.status.field.toUpperCase(),field:o.value.status.field,sortable:!1,filterable:!0,filterOptions:{enabled:!0,placeholder:"status"},editable:!1,type:"text",width:`${o.value.status.width??120}px`,minWidth:"100px",headerClass:"custom-header"}]:[],...we.map(n=>{var Z,ee,te,E,le;const Y=o.value.checkbox.includes(n),be=!Y&&l.data.every(w=>{const ge=w[n];return!isNaN(Number(ge))}),y=(ee=(Z=o.value)==null?void 0:Z.columns)==null?void 0:ee.find(w=>w.column===n);return{label:n.replace(/_/g," ").toUpperCase(),field:n,sortable:!0,filterable:!0,filterOptions:{enabled:!0,placeholder:`${n}`},editable:N.value&&!((le=(E=(te=o.value)==null?void 0:te.uneditable)==null?void 0:E.includes)!=null&&le.call(E,n)),type:Y?"checkbox":be?"number":"text",width:`${(y==null?void 0:y.width)??Math.max(...l.data.map(w=>String((w==null?void 0:w[n])??"").length),n.length)*M[0]+M[1]}px`,minWidth:`${(y==null?void 0:y.minWidth)??M[2]}px`,headerClass:"custome-header"}})]}q=Ce(()=>D.value.map(a=>({...a,filterOptions:{enabled:!1},sortable:!1}))),r.value.data=l.data.map(a=>({...a,filterable:!0})),r.value.data=l.data.map(a=>{const e={};for(const t in a){const u=a[t];if(u==null)e[t]=u;else{const v=Number(u);e[t]=isNaN(v)?String(u):v}}return o.value.status&&o.value.status.calculate&&(e.status=o.value.status.calculate(a)),e.filterable=!0,e}),C.value=[...r.value.data],setTimeout(W,500)}catch(l){$.value="Failed to fetch data",console.error(l)}finally{h.value=!1,J()}},J=()=>{const l={};D.value.forEach(a=>{l[a.field]=o.value.checkbox.includes(a.field)?0:""}),l.id=S.value.length+1,S.value.push(l)},f=(l,a)=>{I.value.has(l.id)?I.value.get(l.id)[a]=l[a]:I.value.set(l.id,{...l})},ie=async()=>{try{const l=Array.from(I.value.values());for(const a of l){const e={...a};for(const t of o.value.toRemove)delete e[t];delete e.id,o.value.date.forEach(t=>{e[t]!==null&&e[t]!==void 0&&!isNaN(Date.parse(e[t]))&&(e[t]=new Date(e[t]).toISOString().split("T")[0])}),Object.keys(e).forEach(t=>{e[t]===""&&(e[t]=null)}),await j.post(c.value.data,e,{headers:{Authorization:`Bearer ${token}`}}),await H(),S.value=[],I.value.clear(),window.location.reload()}}catch(l){console.error("Failed to upload: ",l),alert("Failed to upload")}},m=(l,a)=>{V.value.has(l.id)?V.value.get(l.id)[a]=l[a]:V.value.set(l.id,{...l})},ce=async()=>{const l=Array.from(V.value.values()),a=[];for(const e of l)try{const t=Object.fromEntries(Object.entries(e).filter(([u])=>!o.value.exclude.includes(u)&&!o.value.toRemove.includes(u)));o.value.date.forEach(u=>{t[u]!==null&&t[u]!==void 0&&!isNaN(Date.parse(t[u]))&&(t[u]=new Date(t[u]).toISOString().split("T")[0])}),await j.put(c.value.data,t,{headers:{Authorization:`Bearer ${A.token}`}})}catch(t){console.error("Failed to update row:",e.id,t),a.push(e.id)}a.length>0?alert(`Some rows failed to save: ${a.join(", ")}`):(alert("Changes saved successfully!"),window.location.reload(),V.value.clear())},re=()=>{const l=K.json_to_sheet(C.value),a=K.book_new();K.book_append_sheet(a,l,"Marketing Data"),$e(a,"Filtered_Marketing_Data.xlsx")},fe=l=>{C.value=l,ne("Length : "+C.value.length),ne("onTableFiltered : ",C.value)},W=()=>{const l=document.querySelector(".vue-good-table th:nth-child(1)");l&&(P.value=l.offsetWidth+"px"),document.documentElement.style.setProperty("--second-column-width",P.value)};se({datas:r,loading:h,getLoading:()=>h.value}),_e(()=>{de(),H(),window.addEventListener("resize",W)}),xe(()=>{window.removeEventListener("resize",W)});const Q=l=>{if(l){const[a,e]=l.split(" ");return`${a}T${e.slice(0,5)}`}return""},X=l=>{if(l){const[a,e]=l.split("T"),t=`${e}:00`;return`${a} ${t}`}return""},me=(l,a,e)=>{a[e]=X(l.target.value),m(a,e)},ve=(l,a,e)=>{a[e]=X(l.target.value),f(a,e)};return d(!1),(l,a)=>(s(),i("div",Ve,[_("h2",null,F(L.value.title),1),p.value?(s(),b(T,{key:0,onClick:ie,color:"danger",class:"me-2"},{default:x(()=>a[0]||(a[0]=[R("Upload")])),_:1})):g("",!0),p.value?(s(),b(T,{key:1,onClick:J,color:"danger"},{default:x(()=>a[1]||(a[1]=[R("Add New Row")])),_:1})):g("",!0),h.value?(s(),i("p",Ie,"Loading...")):g("",!0),$.value?(s(),i("p",Ue,F($.value),1)):g("",!0),_("div",pe,[!h.value&&!$.value&&p.value?(s(),b(U(ae),{key:0,columns:U(q),rows:S.value,"search-options":{enabled:!1},"sort-options":{enabled:!1},"line-numbers":!1,"select-options":{enabled:!1},"pagination-options":{enabled:!1},style:{"overflow-x":"auto"}},{"table-row":x(e=>[o.value.checkbox.includes(e.column.field)?(s(),i("div",Ne,[_("input",{type:"checkbox",name:"custom-checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,f(e.row,e.column.field)}},null,8,De)])):Object.keys(r.value.dropdowns).includes(e.column.field)?(s(),b(U(oe),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(f==null?void 0:f(e.row,e.column.field))||(m==null?void 0:m(e.row,e.column.field))],options:r.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?z((s(),i("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>f(e.row,e.column.field)},null,40,Se)),[[B,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),i("input",{key:3,type:"datetime-local",value:Q(e.row[e.column.field]),onInput:t=>ve(t,e.row,e.column.field)},null,40,Oe)):e.column.editable!==!1?z((s(),i("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>f(e.row,e.column.field)},null,40,Ee)),[[B,e.row[e.column.field]]]):(s(),i("span",Fe,F(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):g("",!0)]),_("div",Re,[ke(T,{onClick:re,type:"submit",color:"danger",size:"md",block:!1,class:"me-2"},{default:x(()=>a[2]||(a[2]=[R("Export to Excel")])),_:1}),N.value?(s(),b(T,{key:0,onClick:ce,type:"submit",color:"danger",size:"md",block:!1},{default:x(()=>a[3]||(a[3]=[R("Save Updates")])),_:1})):g("",!0)]),_("div",Te,[!h.value&&!$.value?(s(),b(U(ae),{key:0,columns:D.value,rows:r.value.data,"pagination-options":{enabled:!0,mode:"pages",perPage:10},"search-options":{enabled:!0},"sort-options":{enabled:!0},style:{"overflow-x":"auto"},onOnFiltered:fe,styleClass:"vgt-table striped"},{"table-row":x(e=>[o.value.checkbox.includes(e.column.field)?(s(),i("div",ze,[_("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,m(e.row,e.column.field)}},null,8,Be)])):Object.keys(r.value.dropdowns).includes(e.column.field)&&N.value?(s(),b(U(oe),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(f==null?void 0:f(e.row,e.column.field))||(m==null?void 0:m(e.row,e.column.field))],options:r.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`,noResultsText:"No matching results"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?z((s(),i("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,je)),[[B,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),i("input",{key:3,type:"datetime-local",value:Q(e.row[e.column.field]),onInput:t=>me(t,e.row,e.column.field)},null,40,Ae)):e.column.editable!==!1?z((s(),i("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,Le)),[[B,e.row[e.column.field]]]):(s(),i("span",Me,F(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):g("",!0)])]))}};export{Qe as _};
