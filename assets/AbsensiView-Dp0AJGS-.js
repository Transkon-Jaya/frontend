import{u as te,r as c,n as I,o as ae,x as ne,c as d,a,q as w,t as f,y as se,z as oe,h as S,d as B,f as E,i as le,s as ie,p as $,A as C,P as re,g as p}from"./index-0SadCTHd.js";const ue={class:""},ce={class:"main-content"},de={class:"app-title"},pe={class:"container-global attendance-card-modern mb-3"},me={class:"status-header"},ve={class:"location-info"},fe={key:0},ge={key:1,class:"text-muted"},he={key:0,class:"alert alert-warning"},_e={key:1,class:"attendance-timeline"},we={key:0,class:"timeline-item"},ye={class:"timeline-content"},be={class:"me-2"},ke={key:1,class:"timeline-item"},Me={class:"timeline-content"},De={class:"me-2"},Ae={class:"action-section"},Le={key:0,for:"cameraInput",class:"camera-btn-wrapper"},Se={class:"btn-label"},xe={key:1,class:"success-notice"},Ie={key:2,class:"error-text"},$e={key:3,class:"error-text"},Fe={class:"container-global announcement-card"},Pe={class:"announcement-content"},Ue=["src"],Ce={class:"announcement-text"},Ne={class:"container-global"},Oe={class:"info-card"},ze={class:"info-content"},Te={class:"info-row"},Be={class:"info-value"},Ee={class:"info-row"},Re={class:"info-value"},He={class:"info-row"},Ve={key:0,class:"info-value"},Ge={key:1,class:"info-value text-muted"},Je={class:"info-row"},je={class:"info-value"},Ye=["src"],qe=17,Ke={__name:"AbsensiView",setup(Ze){const m=te();c(null);const u=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],M=c({ipv4:u[0],ipv6:u[0]}),l=c({lat:u[0],lon:u[0]});c({city:u[0],country:u[0],lat:"",lon:""});const x=c(!1),D=c(""),h=c([]),r=c([]),R=c(!0);c(!1);const N=c(""),O=c(null);let k=null;const z=I(()=>![l.value.lat,l.value.lon,M.value.ipv4].some(t=>u.includes(t))),F=I(()=>{var t,e;return(((t=D.value)==null?void 0:t.distance)??99999)>((e=D.value)==null?void 0:e.maxDistance)}),_=I(()=>{const t=r.value[0];if(!t)return"IN";const e=t.hour_in?new Date(t.hour_in):null,n=t.hour_out&&t.hour_out!=="00:00:00"?new Date(t.hour_out):null,o=new Date,i=e&&e.getFullYear()===o.getFullYear()&&e.getMonth()===o.getMonth()&&e.getDate()===o.getDate(),s=e?(o-e)/(1e3*60*60):0,g=n?(o-n)/(1e3*60*60):null;return n&&i||n&&g<2?"DONE":n&&(!i||g>=2)||s>=19?"IN":"OUT"});I(()=>{if(!r.value[0])return!1;const t=r.value[0],e=new Date,n=t.hour_in?new Date(t.hour_in):null,o=t.hour_out?new Date(t.hour_out):null,i=s=>s&&s.getFullYear()===e.getFullYear()&&s.getMonth()===e.getMonth()&&s.getDate()===e.getDate();return i(n)||i(o)});const A=c({photo:null,description:""}),H=async()=>{try{const t=await $.get(`${C}/tools/memo`);A.value.photo=`${re}/memo/${t.data[0].photo}`,A.value.description=t.data[0].description}catch(t){console.error("Failed to fetch memo:",t)}},V=async()=>{try{const t=await fetch(`${m.apiBaseUrl}/absensi-status?username=${m.username}`);r.value=await t.json(),r.value.length>0&&(r.value[0].foto_in=`${m.baseUrl}/uploads/absensi/${r.value[0].foto_in}`,r.value[0].foto_out=`${m.baseUrl}/uploads/absensi/${r.value[0].foto_out}`)}catch(t){console.error("Failed to fetch absensi status:",t)}finally{R.value=!1}},G=()=>new Promise(t=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{l.value.lat=e.coords.latitude.toFixed(6),l.value.lon=e.coords.longitude.toFixed(6),t(!0)},e=>{console.warn("❌ Geolocation permission denied or error:",e.message),l.value.lat=u[1],l.value.lon=u[1],t(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("❌ Unexpected GPS error:",e),l.value.lat=u[2],l.value.lon=u[2],t(!1)}else l.value.lat=u[2],l.value.lon=u[2],t(!1)});function J(t,e,n,o){const s=(n-t)*Math.PI/180,g=(o-e)*Math.PI/180,v=Math.sin(s/2)**2+Math.cos(t*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(g/2)**2,b=6371*(2*Math.atan2(Math.sqrt(v),Math.sqrt(1-v)))*1e3;return isNaN(b)?0:b.toFixed(2)}const j=async()=>{try{const t=await $.get(`${C}/hr-lokasi`,{headers:{Authorization:`Bearer ${m.token}`}});h.value=t.data.map(e=>{const n=e.latitude??null,o=e.longitude??null,i=e.maxDistance!=null?parseInt(e.maxDistance,10):null,s=n!==null&&o!==null&&l.value.lat&&l.value.lon?J(l.value.lat,l.value.lon,n,o):1/0;return{nama:e.nama??"",lat:n,lon:o,distance:s,maxDistance:i}}),h.value.sort((e,n)=>e.distance-n.distance),h.value.length>0&&(D.value=h.value[0])}catch(t){console.error("Failed to fetch locations:",t)}},Y=async()=>{try{const t=await $.get(`${C}/ip`,{headers:{Authorization:`Bearer ${m.token}`}});M.value.ipv4=t.data.ip}catch(t){console.error("Error fetching IP:",t),M.value.ipv4=u[2]}},q=()=>{const t=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,n=e.match(/\(([^)]+)\)/);let o=n?n[1]:`?${e}`;return o.length>250&&(o=o.substring(0,250)),{dimension:t,device:o}},Z=t=>new Promise(e=>{const n=new FileReader;n.onload=o=>{const i=new Image;i.onload=()=>{const s=document.createElement("canvas"),g=s.getContext("2d");s.width=600,s.height=800;const v=i.width/i.height;let y,b;v>600/800?(b=800,y=800*v):(y=600,b=600/v);const Q=(600-y)/2,X=(800-b)/2;g.drawImage(i,Q,X,y,b),s.toBlob(ee=>{e(new File([ee],t.name,{type:"image/jpeg",lastModified:Date.now()}))},"image/jpeg",.9)},i.src=o.target.result},n.readAsDataURL(t)}),W=async t=>{const e=t.target.files[0];if(e)try{const n=await Z(e),{dimension:o,device:i}=q(),s=new FormData;s.append("foto",n),s.append("id",_.value=="IN"?null:r.value[0].id),s.append("status",_.value),s.append("username",m.username),s.append("lokasi",D.value.nama),s.append("jarak",D.value.distance),s.append("long",l.value.lon),s.append("lang",l.value.lat),s.append("ip",M.value.ipv4),s.append("dim",o),s.append("device",i);const v=(await $.post("https://www.transkon-rent.com/api/absensi",s,{headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"multipart/form-data"}})).data;v.status==="success"?(x.value=!0,window.location.reload()):console.error("Attendance failed:",v.message)}catch(n){console.error("Upload error:",n)}},P=c(!1),U=t=>{N.value=t,P.value=!0},K=()=>{P.value=!1};ae(async()=>{try{const t=await G();if(await Promise.all([H(),j(),Y(),V()]),t&&l.value.lat&&l.value.lon){const e=parseFloat(l.value.lat),n=parseFloat(l.value.lon);k=L.map(O.value).setView([e,n],qe),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(k),L.marker([e,n]).addTo(k).bindPopup("Lokasi Anda").openPopup()}window.sendUserToFlutter&&(m!=null&&m.id)&&window.sendUserToFlutter(m.id)}catch(t){console.error("💥 Unhandled error in onMounted:",t)}}),ne(()=>{k&&(k.remove(),k=null)});function T(t){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],n=new Date(t),o=n.getDate(),i=e[n.getMonth()],s=n.getFullYear(),g=String(n.getHours()).padStart(2,"0"),v=String(n.getMinutes()).padStart(2,"0"),y=String(n.getSeconds()).padStart(2,"0");return`${o} ${i} ${s} ${g}:${v}:${y}`}return(t,e)=>{var o,i;const n=le("VButton");return p(),d("div",ue,[a("main",ce,[a("h1",de,"Hi, "+f(se(m).name),1),e[24]||(e[24]=a("p",{class:"app-subtitle"},null,-1)),a("div",pe,[a("div",me,[e[4]||(e[4]=a("h3",null,"Absensi Hari Ini",-1)),a("div",{class:oe(["status-badge",`status-${_.value.toLowerCase()}`])},f(_.value==="IN"?"DATANG":_.value==="OUT"?"PULANG":"SELESAI"),3)]),a("div",ve,[e[5]||(e[5]=a("i",{class:"fa-solid fa-location-dot"},null,-1)),h.value.length>0?(p(),d("span",fe,f(h.value[0].nama),1)):(p(),d("span",ge,"Mencari lokasi..."))]),F.value?(p(),d("div",he,e[6]||(e[6]=[a("i",{class:"fa-solid fa-triangle-exclamation"},null,-1),S(" Anda berada di luar zona absensi ")]))):w("",!0),_.value!=="IN"?(p(),d("div",_e,[(o=r.value[0])!=null&&o.hour_in?(p(),d("div",we,[e[9]||(e[9]=a("div",{class:"timeline-dot success"},null,-1)),a("div",ye,[e[8]||(e[8]=a("strong",null,"Absen Datang",-1)),a("small",be,f(T(r.value[0].hour_in)),1),B(n,{onClick:e[0]||(e[0]=s=>U(r.value[0].foto_in)),size:"sm",class:"mt-1"},{default:E(()=>e[7]||(e[7]=[a("i",{class:"fa-solid fa-image"},null,-1),S(" Lihat Foto ")])),_:1})])])):w("",!0),(i=r.value[0])!=null&&i.hour_out?(p(),d("div",ke,[e[12]||(e[12]=a("div",{class:"timeline-dot warning"},null,-1)),a("div",Me,[e[11]||(e[11]=a("strong",null,"Absen Pulang",-1)),a("small",De,f(T(r.value[0].hour_out)),1),B(n,{onClick:e[1]||(e[1]=s=>U(r.value[0].foto_out)),size:"sm",class:"mt-1"},{default:E(()=>e[10]||(e[10]=[a("i",{class:"fa-solid fa-image"},null,-1),S(" Lihat Foto ")])),_:1})])])):w("",!0)])):w("",!0),a("div",Ae,[a("input",{type:"file",accept:"image/*",capture:"environment",onChange:W,id:"cameraInput",style:{display:"none"}},null,32),!x.value&&z.value&&!F.value&&_.value!=="DONE"?(p(),d("label",Le,[e[13]||(e[13]=a("div",{class:"camera-btn pulse"},[a("i",{class:"fa-solid fa-camera"})],-1)),a("p",Se,f(_.value==="OUT"?"Ambil Foto Pulang":"Ambil Foto Datang"),1)])):w("",!0),x.value?(p(),d("div",xe,e[14]||(e[14]=[a("i",{class:"fa-solid fa-check-circle"},null,-1),a("span",null,"Absensi berhasil direkam!",-1)]))):w("",!0),z.value?F.value&&!x.value?(p(),d("p",$e,e[16]||(e[16]=[a("i",{class:"fa-solid fa-radar"},null,-1),S(" Di luar jangkauan lokasi absensi ")]))):w("",!0):(p(),d("p",Ie,e[15]||(e[15]=[a("i",{class:"fa-solid fa-circle-exclamation"},null,-1),S(" Gagal memuat data lokasi ")])))])]),a("div",Fe,[e[17]||(e[17]=a("div",{class:"announcement-header"},[a("i",{class:"fa-solid fa-bullhorn announcement-icon"}),a("h3",null,"TRJA Memo")],-1)),a("div",Pe,[a("img",{src:A.value.photo,alt:"TRJA Memo",class:"announcement-image",onClick:e[2]||(e[2]=s=>U(A.value.photo)),style:{cursor:"pointer"}},null,8,Ue),a("p",Ce,f(A.value.description),1)])]),a("div",Ne,[a("div",Oe,[e[22]||(e[22]=a("div",{class:"info-header"},[a("i",{class:"fa-solid fa-map-marker-alt"}),a("h4",null,"Lokasi GPS Anda")],-1)),a("div",ze,[a("div",Te,[e[18]||(e[18]=a("span",{class:"info-label"},"Latitude:",-1)),a("span",Be,f(l.value.lat),1)]),a("div",Ee,[e[19]||(e[19]=a("span",{class:"info-label"},"Longitude:",-1)),a("span",Re,f(l.value.lon),1)]),a("div",He,[e[20]||(e[20]=a("span",{class:"info-label"},"Jarak:",-1)),h.value.length>0?(p(),d("span",Ve,f(h.value[0].distance+" Meter"),1)):(p(),d("span",Ge," Menghitung Jarak.. "))]),a("div",Je,[e[21]||(e[21]=a("span",{class:"info-label"},"IPv4:",-1)),a("span",je,f(M.value.ipv4),1)]),a("div",{ref_key:"gpsMapContainer",ref:O,class:"map-container-leaflet"},null,512)])]),e[23]||(e[23]=a("p",null,[a("span",{style:{color:"red","font-size":"10px"}}," *Segala bentuk kecurangan pencatatan kehadiran dapat terdeteksi dan akan ditindaklanjuti ")],-1))]),P.value?(p(),d("div",{key:0,class:"memo-overlay",onClick:K},[a("img",{src:N.value,onClick:e[3]||(e[3]=ie(()=>{},["stop"]))},null,8,Ye)])):w("",!0)])])}}};export{Ke as default};
