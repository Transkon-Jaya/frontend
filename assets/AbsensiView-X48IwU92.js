import{_ as ee,c as u,p as S,g as d,a,q as V,t as m,u as ae,r as c,m as P,o as te,s as oe,d as k,f as C,i as z,x as A,A as N,P as ne,h as J}from"./index-CflXBBsf.js";const se={props:{imageSrc:{type:String,required:!0},imageTitle:{type:String,default:"Image Preview"},showModal:{type:Boolean,default:!1}},methods:{closeModal(){this.$emit("close")},handleKeydown(I){I.key==="Escape"&&this.closeModal()}},mounted(){window.addEventListener("keydown",this.handleKeydown)},beforeUnmount(){window.removeEventListener("keydown",this.handleKeydown)}},le={class:"modal-dialog modal-dialog-centered",role:"document"},ie={class:"modal-header"},re={class:"modal-title",id:"imageModalLabel"},ce={class:"modal-body"},ue=["src"];function de(I,l,i,b,n,p){return i.showModal?(d(),u("div",{key:0,class:"modal fade show",tabindex:"-1",role:"dialog","aria-labelledby":"imageModalLabel",style:{display:"block"},"aria-hidden":"false",onClick:l[2]||(l[2]=V((...y)=>p.closeModal&&p.closeModal(...y),["self"]))},[a("div",le,[a("div",{class:"modal-content",onClick:l[1]||(l[1]=V(()=>{},["stop"]))},[a("div",ie,[a("h5",re,m(i.imageTitle),1),a("button",{type:"button",class:"close",onClick:l[0]||(l[0]=(...y)=>p.closeModal&&p.closeModal(...y)),"aria-label":"Close"},l[3]||(l[3]=[a("span",{"aria-hidden":"true"},"×",-1)]))]),a("div",ce,[a("img",{src:i.imageSrc,alt:"Image Preview",class:"img-fluid"},null,8,ue)])])])])):S("",!0)}const R=ee(se,[["render",de],["__scopeId","data-v-b06dafc1"]]),ve={class:"app-container"},me={class:"main-content"},pe={class:"app-title"},he={class:"container-global attendance-card"},ge={class:"form-group"},fe={key:0,id:"location",class:"form-control-plaintext"},_e={key:1,class:"form-control-plaintext text-muted"},be={key:0,class:"mb-4"},ye={key:1,class:"mb-4"},Me={class:"action-group"},we={key:0},ke={key:1},Se={key:2},$e={key:3},De={key:2,class:"confirmation-message"},Ae={class:"container-global announcement-card"},Ie={class:"announcement-content"},xe=["src"],Le={class:"announcement-text"},Pe={class:"container-global info-section-edit"},Ce={class:"info-card"},Ne={class:"info-content"},Ue={class:"info-row"},Be={class:"info-value"},Ee={class:"info-row"},Oe={class:"info-value"},Te={class:"info-row"},Fe={key:0,class:"info-value"},Ge={key:1,class:"info-value text-muted"},Ve={class:"info-row"},ze={class:"info-value"},Je=["src"],Re=12,qe={__name:"AbsensiView",setup(I){const l=ae();c(null);const i=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],b=c({ipv4:i[0],ipv6:i[0]}),n=c({lat:i[0],lon:i[0]});c({city:i[0],country:i[0],lat:"",lon:""});const p=c("");c("");const y=c(!1),_=c(""),h=c([]),v=c([]),x=c(!0),$=c(!1),L=c(""),U=P(()=>![n.value.lat,n.value.lon,b.value.ipv4].some(t=>i.includes(t))),B=P(()=>{var t,e;return(((t=_.value)==null?void 0:t.distance)??99999)>((e=_.value)==null?void 0:e.maxDistance)}),g=P(()=>{const t=v.value[0];if(!t)return"IN";const e=t.hour_in?new Date(t.hour_in):null,o=new Date,r=e&&e.getFullYear()===o.getFullYear()&&e.getMonth()===o.getMonth()&&e.getDate()===o.getDate(),s=e?(o-e)/(1e3*60*60):null;return!r&&(t.hour_out||s>=16)?"IN":!t.hour_out||t.hour_out==="00:00:00"?"OUT":"DONE"}),w=c({photo:null,description:""}),H=async()=>{const t=await A.get(`${N}/tools/memo`);console.log(t),w.value.photo=`${ne}/memo/${t.data[0].photo}`,w.value.description=t.data[0].description,console.log(w.value)},q=async()=>{const t=await fetch(`${l.apiBaseUrl}/absensi-status?username=${l.username}`);v.value=await t.json(),v.value.length>0&&(v.value[0].foto_in=`${l.baseUrl}/uploads/absensi/${v.value[0].foto_in}`,v.value[0].foto_out=`${l.baseUrl}/uploads/absensi/${v.value[0].foto_out}`),x.value=!1},K=()=>new Promise(t=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{n.value.lat=e.coords.latitude.toFixed(6),n.value.lon=e.coords.longitude.toFixed(6),p.value=`https://static-maps.yandex.ru/1.x/?lang=en-US&ll=${n.value.lon},${n.value.lat}&size=450,300&z=${Re}&l=map&pt=${n.value.lon},${n.value.lat},pm2rdm`,t(!0)},e=>{console.warn("❌ Geolocation permission denied or error:",e.message),n.value.lat=i[1],n.value.lon=i[1],t(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("❌ Unexpected GPS error:",e),n.value.lat=i[2],n.value.lon=i[2],t(!1)}else n.value.lat=i[2],n.value.lon=i[2],t(!1)});function j(t,e,o,r){const f=(o-t)*Math.PI/180,M=(r-e)*Math.PI/180,D=Math.sin(f/2)**2+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(M/2)**2,G=6371*(2*Math.atan2(Math.sqrt(D),Math.sqrt(1-D)))*1e3;return isNaN(G)?0:G.toFixed(2)}const Y=async()=>{const t=await A.get(`${N}/hr-lokasi`,{headers:{Authorization:`Bearer ${l.token}`}});h.value=t.data.map(e=>{const o=e.latitude??null,r=e.longitude??null,s=e.maxDistance!=null?parseInt(e.maxDistance,10):null,f=o!==null&&r!==null&&n.value.lat&&n.value.lon?j(n.value.lat,n.value.lon,o,r):1/0;return{nama:e.nama??"",lat:o,lon:r,distance:f,maxDistance:s}}),h.value.sort((e,o)=>e.distance-o.distance),h.value.length>0&&(_.value=h.value[0])},Z=async()=>{try{const t=await A.get(`${N}/ip`,{headers:{Authorization:`Bearer ${l.token}`}});b.value.ipv4=t.data.ip}catch(t){console.error("Error fetching IP:",t),b.value.ipv4=i[2]}},E=t=>{L.value=t,$.value=!0},O=()=>{$.value=!1},W=()=>{if(!_.value){alert("Silakan pilih lokasi absen terlebih dahulu!");return}document.getElementById("cameraInput").click()},Q=()=>{const t=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,o=e.match(/\(([^)]+)\)/);let r=o?o[1]:`?${e}`;return r.length>250&&(r=r.substring(0,250)),{dimension:t,device:r}},X=async t=>{const e=t.target.files[0];if(e)try{const{dimension:o,device:r}=Q(),s=new FormData;s.append("foto",e),s.append("id",g.value=="IN"?null:v.value[0].id),s.append("status",g.value),s.append("username",l.username),s.append("lokasi",_.value.nama),s.append("jarak",_.value.distance),s.append("long",n.value.lon),s.append("lang",n.value.lat),s.append("ip",b.value.ipv4),s.append("dim",o),s.append("device",r);const M=(await A.post("https://www.transkon-rent.com/api/absensi",s,{headers:{Authorization:`Bearer ${l.token}`,"Content-Type":"multipart/form-data"}})).data;M.status==="success"?(y.value=!0,window.location.reload()):console.error("Attendance failed:",M.message)}catch(o){console.error("Upload error:",o)}};te(async()=>{try{console.log("1. Meminta izin GPS..."),await K()||console.warn("⚠️ Lokasi gagal dimuat. Melanjutkan tanpa GPS..."),await Promise.all([H(),Y(),Z(),q()]),console.log("✅ Semua data berhasil dimuat.")}catch(t){console.error("💥 Unhandled error in onMounted:",t)}});function T(t){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],o=new Date(t),r=o.getDate(),s=e[o.getMonth()],f=o.getFullYear(),M=String(o.getHours()).padStart(2,"0"),D=String(o.getMinutes()).padStart(2,"0"),F=String(o.getSeconds()).padStart(2,"0");return`${r} ${s} ${f} ${M}:${D}:${F}`}return(t,e)=>{var s;const o=z("VButton"),r=z("Button");return d(),u("div",ve,[a("main",me,[a("h1",pe,"Hi, "+m(oe(l).name),1),e[12]||(e[12]=a("p",{class:"app-subtitle"},null,-1)),a("div",he,[a("div",ge,[h.value.length>0?(d(),u("p",fe,m(h.value[0].nama),1)):(d(),u("p",_e,"Loading location..."))]),g.value==="OUT"||g.value==="DONE"?(d(),u("div",be,[a("div",null,m(T(v.value[0].hour_in)),1),k(o,{onClick:e[0]||(e[0]=f=>E(v.value[0].foto_in)),class:"btn btn-danger"},{default:C(()=>e[2]||(e[2]=[J("Photo In")])),_:1}),k(R,{imageSrc:L.value,showModal:$.value,onClose:O},null,8,["imageSrc","showModal"])])):S("",!0),g.value==="DONE"?(d(),u("div",ye,[a("div",null,m(T((s=v.value[0])==null?void 0:s.hour_out)),1),k(o,{onClick:e[1]||(e[1]=f=>E(v.value[0].foto_out)),class:"btn btn-danger"},{default:C(()=>e[3]||(e[3]=[J("Photo Out")])),_:1}),k(R,{imageSrc:L.value,showModal:$.value,onClose:O},null,8,["imageSrc","showModal"])])):S("",!0),a("div",Me,[a("input",{type:"file",accept:"image/*",capture:"environment",onChange:X,id:"cameraInput",style:{display:"none"}},null,32),k(r,{onClick:W,class:"primary-btn",disabled:!_.value||g.value==="DONE"||x.value||!U.value||B.value},{default:C(()=>[e[4]||(e[4]=a("i",{class:"fa-solid fa-camera"},null,-1)),x.value?(d(),u("span",we,"Loading...")):U.value?B.value?(d(),u("span",Se,"Anda Diluar Zona Absensi")):(d(),u("span",$e,m(g.value==="DONE"?"Sudah Absen":g.value==="OUT"?"Absen OUT":"Absen IN"),1)):(d(),u("span",ke,"Gagal Memuat"))]),_:1},8,["disabled"])]),y.value?(d(),u("div",De,e[5]||(e[5]=[a("i",{class:"fa-solid fa-check-circle success-icon"},null,-1),a("span",null,"Absensi berhasil direkam!",-1)]))):S("",!0)]),a("div",Ae,[e[6]||(e[6]=a("div",{class:"announcement-header"},[a("i",{class:"fa-solid fa-bullhorn announcement-icon"}),a("h3",null,"TRJA Memo")],-1)),a("div",Ie,[a("img",{src:w.value.photo,alt:"TRJA Memo",class:"announcement-image"},null,8,xe),a("p",Le,m(w.value.description),1)])]),a("div",Pe,[a("div",Ce,[e[11]||(e[11]=a("div",{class:"info-header"},[a("i",{class:"fa-solid fa-map-marker-alt"}),a("h4",null,"Lokasi GPS Anda")],-1)),a("div",Ne,[a("div",Ue,[e[7]||(e[7]=a("span",{class:"info-label"},"Latitude:",-1)),a("span",Be,m(n.value.lat),1)]),a("div",Ee,[e[8]||(e[8]=a("span",{class:"info-label"},"Longitude:",-1)),a("span",Oe,m(n.value.lon),1)]),a("div",Te,[e[9]||(e[9]=a("span",{class:"info-label"},"Jarak:",-1)),h.value.length>0?(d(),u("span",Fe,m(h.value[0].distance+" Meter"),1)):(d(),u("span",Ge," Menghitung Jarak.. "))]),a("div",Ve,[e[10]||(e[10]=a("span",{class:"info-label"},"IPv4:",-1)),a("span",ze,m(b.value.ipv4),1)]),p.value?(d(),u("img",{key:0,src:p.value,alt:"GPS Map",class:"map-image"},null,8,Je)):S("",!0)])])])])])}}};export{qe as default};
