import{_ as oe,c as u,q as x,g as m,a as t,s as R,t as g,u as se,r as d,n as C,o as le,x as ie,d as D,f as B,i as G,p as A,A as E,P as re,h as H}from"./index-D2aGOXAB.js";const ce={props:{imageSrc:{type:String,required:!0},imageTitle:{type:String,default:"Image Preview"},showModal:{type:Boolean,default:!1}},methods:{closeModal(){this.$emit("close")},handleKeydown(L){L.key==="Escape"&&this.closeModal()}},mounted(){window.addEventListener("keydown",this.handleKeydown)},beforeUnmount(){window.removeEventListener("keydown",this.handleKeydown)}},de={class:"modal-dialog modal-dialog-centered",role:"document"},ue={class:"modal-header"},me={class:"modal-title",id:"imageModalLabel"},pe={class:"modal-body"},ve=["src"];function ge(L,i,r,M,l,f){return r.showModal?(m(),u("div",{key:0,class:"modal fade show",tabindex:"-1",role:"dialog","aria-labelledby":"imageModalLabel",style:{display:"block"},"aria-hidden":"false",onClick:i[2]||(i[2]=R((...S)=>f.closeModal&&f.closeModal(...S),["self"]))},[t("div",de,[t("div",{class:"modal-content",onClick:i[1]||(i[1]=R(()=>{},["stop"]))},[t("div",ue,[t("h5",me,g(r.imageTitle),1),t("button",{type:"button",class:"close",onClick:i[0]||(i[0]=(...S)=>f.closeModal&&f.closeModal(...S)),"aria-label":"Close"},i[3]||(i[3]=[t("span",{"aria-hidden":"true"},"×",-1)]))]),t("div",pe,[t("img",{src:r.imageSrc,alt:"Image Preview",class:"img-fluid"},null,8,ve)])])])])):x("",!0)}const V=oe(ce,[["render",ge],["__scopeId","data-v-b06dafc1"]]),he={class:"app-container"},fe={class:"main-content"},_e={class:"app-title"},we={class:"container-global attendance-card"},be={class:"form-group"},ye={key:0,id:"location",class:"form-control-plaintext"},ke={key:1,class:"form-control-plaintext text-muted"},Me={key:0,class:"mb-4"},Se={key:1,class:"mb-4"},$e={class:"action-group"},De={key:0},xe={key:1},Ie={key:2},Ae={key:3},Le={key:2,class:"confirmation-message"},Pe={class:"container-global announcement-card"},Ue={class:"announcement-content"},Ce=["src"],Be={class:"announcement-text"},Ee={class:"container-global info-section-edit"},Oe={class:"info-card"},Fe={class:"info-content"},Ne={class:"info-row"},Te={class:"info-value"},ze={class:"info-row"},Re={class:"info-value"},Ge={class:"info-row"},He={key:0,class:"info-value"},Ve={key:1,class:"info-value text-muted"},Je={class:"info-row"},je={class:"info-value"},qe=["src"],Ke=12,We={__name:"AbsensiView",setup(L){const i=se();d(null);const r=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],M=d({ipv4:r[0],ipv6:r[0]}),l=d({lat:r[0],lon:r[0]});d({city:r[0],country:r[0],lat:"",lon:""});const f=d("");d("");const S=d(!1),b=d(""),_=d([]),p=d([]),P=d(!0),I=d(!1),U=d(""),O=C(()=>![l.value.lat,l.value.lon,M.value.ipv4].some(a=>r.includes(a))),F=C(()=>{var a,e;return(((a=b.value)==null?void 0:a.distance)??99999)>((e=b.value)==null?void 0:e.maxDistance)}),w=C(()=>{const a=p.value[0];if(!a)return"IN";const e=a.hour_in?new Date(a.hour_in):null,n=a.hour_out&&a.hour_out!=="00:00:00"?new Date(a.hour_out):null,s=new Date,c=e&&e.getFullYear()===s.getFullYear()&&e.getMonth()===s.getMonth()&&e.getDate()===s.getDate(),o=e?(s-e)/(1e3*60*60):0,h=n?(s-n)/(1e3*60*60):null;return n&&c||n&&h<2?"DONE":n&&(!c||h>=2)||o>=16?"IN":"OUT"}),$=d({photo:null,description:""}),J=async()=>{const a=await A.get(`${E}/tools/memo`);console.log(a),$.value.photo=`${re}/memo/${a.data[0].photo}`,$.value.description=a.data[0].description,console.log($.value)},j=async()=>{const a=await fetch(`${i.apiBaseUrl}/absensi-status?username=${i.username}`);p.value=await a.json(),p.value.length>0&&(p.value[0].foto_in=`${i.baseUrl}/uploads/absensi/${p.value[0].foto_in}`,p.value[0].foto_out=`${i.baseUrl}/uploads/absensi/${p.value[0].foto_out}`),P.value=!1},q=()=>new Promise(a=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{l.value.lat=e.coords.latitude.toFixed(6),l.value.lon=e.coords.longitude.toFixed(6),f.value=`https://static-maps.yandex.ru/1.x/?lang=en-US&ll=${l.value.lon},${l.value.lat}&size=450,300&z=${Ke}&l=map&pt=${l.value.lon},${l.value.lat},pm2rdm`,a(!0)},e=>{console.warn("❌ Geolocation permission denied or error:",e.message),l.value.lat=r[1],l.value.lon=r[1],a(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("❌ Unexpected GPS error:",e),l.value.lat=r[2],l.value.lon=r[2],a(!1)}else l.value.lat=r[2],l.value.lon=r[2],a(!1)});function K(a,e,n,s){const o=(n-a)*Math.PI/180,h=(s-e)*Math.PI/180,v=Math.sin(o/2)**2+Math.cos(a*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(h/2)**2,k=6371*(2*Math.atan2(Math.sqrt(v),Math.sqrt(1-v)))*1e3;return isNaN(k)?0:k.toFixed(2)}const Y=async()=>{const a=await A.get(`${E}/hr-lokasi`,{headers:{Authorization:`Bearer ${i.token}`}});_.value=a.data.map(e=>{const n=e.latitude??null,s=e.longitude??null,c=e.maxDistance!=null?parseInt(e.maxDistance,10):null,o=n!==null&&s!==null&&l.value.lat&&l.value.lon?K(l.value.lat,l.value.lon,n,s):1/0;return{nama:e.nama??"",lat:n,lon:s,distance:o,maxDistance:c}}),_.value.sort((e,n)=>e.distance-n.distance),_.value.length>0&&(b.value=_.value[0])},W=async()=>{try{const a=await A.get(`${E}/ip`,{headers:{Authorization:`Bearer ${i.token}`}});M.value.ipv4=a.data.ip}catch(a){console.error("Error fetching IP:",a),M.value.ipv4=r[2]}},N=a=>{U.value=a,I.value=!0},T=()=>{I.value=!1},Z=()=>{if(!b.value){alert("Silakan pilih lokasi absen terlebih dahulu!");return}document.getElementById("cameraInput").click()},Q=()=>{const a=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,n=e.match(/\(([^)]+)\)/);let s=n?n[1]:`?${e}`;return s.length>250&&(s=s.substring(0,250)),{dimension:a,device:s}},X=a=>new Promise(e=>{const n=new FileReader;n.onload=s=>{const c=new Image;c.onload=()=>{const o=document.createElement("canvas"),h=o.getContext("2d");o.width=600,o.height=800;const v=c.width/c.height;let y,k;v>600/800?(k=800,y=800*v):(y=600,k=600/v);const ae=(600-y)/2,te=(800-k)/2;h.drawImage(c,ae,te,y,k),o.toBlob(ne=>{e(new File([ne],a.name,{type:"image/jpeg",lastModified:Date.now()}))},"image/jpeg",.9)},c.src=s.target.result},n.readAsDataURL(a)}),ee=async a=>{const e=a.target.files[0];if(e)try{const n=await X(e),{dimension:s,device:c}=Q(),o=new FormData;o.append("foto",n),o.append("id",w.value=="IN"?null:p.value[0].id),o.append("status",w.value),o.append("username",i.username),o.append("lokasi",b.value.nama),o.append("jarak",b.value.distance),o.append("long",l.value.lon),o.append("lang",l.value.lat),o.append("ip",M.value.ipv4),o.append("dim",s),o.append("device",c);const v=(await A.post("https://www.transkon-rent.com/api/absensi",o,{headers:{Authorization:`Bearer ${i.token}`,"Content-Type":"multipart/form-data"}})).data;v.status==="success"?(S.value=!0,window.location.reload()):console.error("Attendance failed:",v.message)}catch(n){console.error("Upload error:",n)}};le(async()=>{try{console.log("1. Meminta izin GPS..."),await q()||console.warn("⚠️ Lokasi gagal dimuat. Melanjutkan tanpa GPS..."),await Promise.all([J(),Y(),W(),j()]),console.log("✅ Semua data berhasil dimuat."),window.sendUserToFlutter&&(i!=null&&i.id)&&window.sendUserToFlutter(i.id)}catch(a){console.error("💥 Unhandled error in onMounted:",a)}});function z(a){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],n=new Date(a),s=n.getDate(),c=e[n.getMonth()],o=n.getFullYear(),h=String(n.getHours()).padStart(2,"0"),v=String(n.getMinutes()).padStart(2,"0"),y=String(n.getSeconds()).padStart(2,"0");return`${s} ${c} ${o} ${h}:${v}:${y}`}return(a,e)=>{var c;const n=G("VButton"),s=G("Button");return m(),u("div",he,[t("main",fe,[t("h1",_e,"Hi, "+g(ie(i).name),1),e[13]||(e[13]=t("p",{class:"app-subtitle"},null,-1)),t("div",we,[t("div",be,[_.value.length>0?(m(),u("p",ye,g(_.value[0].nama),1)):(m(),u("p",ke,"Loading location..."))]),w.value==="OUT"||w.value==="DONE"?(m(),u("div",Me,[t("div",null,g(z(p.value[0].hour_in)),1),D(n,{onClick:e[0]||(e[0]=o=>N(p.value[0].foto_in)),class:"btn btn-danger"},{default:B(()=>e[2]||(e[2]=[H("Photo In")])),_:1}),D(V,{imageSrc:U.value,showModal:I.value,onClose:T},null,8,["imageSrc","showModal"])])):x("",!0),w.value==="DONE"?(m(),u("div",Se,[t("div",null,g(z((c=p.value[0])==null?void 0:c.hour_out)),1),D(n,{onClick:e[1]||(e[1]=o=>N(p.value[0].foto_out)),class:"btn btn-danger"},{default:B(()=>e[3]||(e[3]=[H("Photo Out")])),_:1}),D(V,{imageSrc:U.value,showModal:I.value,onClose:T},null,8,["imageSrc","showModal"])])):x("",!0),t("div",$e,[t("input",{type:"file",accept:"image/*",capture:"environment",onChange:ee,id:"cameraInput",style:{display:"none"}},null,32),D(s,{onClick:Z,class:"primary-btn",disabled:!b.value||w.value==="DONE"||P.value||!O.value||F.value},{default:B(()=>[e[4]||(e[4]=t("i",{class:"fa-solid fa-camera"},null,-1)),P.value?(m(),u("span",De,"Loading...")):O.value?F.value?(m(),u("span",Ie,"Anda Diluar Zona Absensi")):(m(),u("span",Ae,g(w.value==="DONE"?"Sudah Absen":w.value==="OUT"?"Absen Pulang":"Absen Datang"),1)):(m(),u("span",xe,"Gagal Memuat"))]),_:1},8,["disabled"])]),S.value?(m(),u("div",Le,e[5]||(e[5]=[t("i",{class:"fa-solid fa-check-circle success-icon"},null,-1),t("span",null,"Absensi berhasil direkam!",-1)]))):x("",!0)]),t("div",Pe,[e[6]||(e[6]=t("div",{class:"announcement-header"},[t("i",{class:"fa-solid fa-bullhorn announcement-icon"}),t("h3",null,"TRJA Memo")],-1)),t("div",Ue,[t("img",{src:$.value.photo,alt:"TRJA Memo",class:"announcement-image"},null,8,Ce),t("p",Be,g($.value.description),1)])]),t("div",Ee,[t("div",Oe,[e[11]||(e[11]=t("div",{class:"info-header"},[t("i",{class:"fa-solid fa-map-marker-alt"}),t("h4",null,"Lokasi GPS Anda")],-1)),t("div",Fe,[t("div",Ne,[e[7]||(e[7]=t("span",{class:"info-label"},"Latitude:",-1)),t("span",Te,g(l.value.lat),1)]),t("div",ze,[e[8]||(e[8]=t("span",{class:"info-label"},"Longitude:",-1)),t("span",Re,g(l.value.lon),1)]),t("div",Ge,[e[9]||(e[9]=t("span",{class:"info-label"},"Jarak:",-1)),_.value.length>0?(m(),u("span",He,g(_.value[0].distance+" Meter"),1)):(m(),u("span",Ve," Menghitung Jarak.. "))]),t("div",Je,[e[10]||(e[10]=t("span",{class:"info-label"},"IPv4:",-1)),t("span",je,g(M.value.ipv4),1)]),f.value?(m(),u("img",{key:0,src:f.value,alt:"GPS Map",class:"map-image"},null,8,qe)):x("",!0)])]),e[12]||(e[12]=t("p",null,[t("span",{style:{color:"red","font-size":"10px"}}," *Segala bentuk kecurangan pencatatan kehadiran dapat terdeteksi dan akan ditindaklanjuti ")],-1))])])])}}};export{We as default};
