import{_ as ce,c as u,q as A,g as p,a,s as N,t as g,u as de,r as d,n as U,o as ue,x as pe,y as me,d as x,f as B,i as G,p as P,A as E,P as ve,h as j}from"./index-g6npIRNv.js";const he={props:{imageSrc:{type:String,required:!0},imageTitle:{type:String,default:"Image Preview"},showModal:{type:Boolean,default:!1}},methods:{closeModal(){this.$emit("close")},handleKeydown(C){C.key==="Escape"&&this.closeModal()}},mounted(){window.addEventListener("keydown",this.handleKeydown)},beforeUnmount(){window.removeEventListener("keydown",this.handleKeydown)}},ge={class:"modal-dialog modal-dialog-centered",role:"document"},fe={class:"modal-header"},_e={class:"modal-title",id:"imageModalLabel"},we={class:"modal-body"},ye=["src"];function be(C,i,r,M,l,y){return r.showModal?(p(),u("div",{key:0,class:"modal fade show",tabindex:"-1",role:"dialog","aria-labelledby":"imageModalLabel",style:{display:"block"},"aria-hidden":"false",onClick:i[2]||(i[2]=N((...v)=>y.closeModal&&y.closeModal(...v),["self"]))},[a("div",ge,[a("div",{class:"modal-content",onClick:i[1]||(i[1]=N(()=>{},["stop"]))},[a("div",fe,[a("h5",_e,g(r.imageTitle),1),a("button",{type:"button",class:"close",onClick:i[0]||(i[0]=(...v)=>y.closeModal&&y.closeModal(...v)),"aria-label":"Close"},i[3]||(i[3]=[a("span",{"aria-hidden":"true"},"Ã—",-1)]))]),a("div",we,[a("img",{src:r.imageSrc,alt:"Image Preview",class:"img-fluid"},null,8,ye)])])])])):A("",!0)}const q=ce(he,[["render",be],["__scopeId","data-v-b06dafc1"]]),ke={class:"app-container"},Me={class:"main-content"},Se={class:"app-title"},De={class:"container-global attendance-card"},Le={class:"form-group"},$e={key:0,id:"location",class:"form-control-plaintext"},xe={key:1,class:"form-control-plaintext text-muted"},Ae={key:0,class:"mb-4"},Ie={key:1,class:"mb-4"},Pe={class:"action-group"},Ce={key:0},Fe={key:1},Oe={key:2},Ue={key:3},Be={key:2,class:"confirmation-message"},Ee={class:"container-global announcement-card"},Ne={class:"announcement-content"},Te=["src"],Re={class:"announcement-text"},Ve={class:"container-global"},ze={class:"info-card"},He={class:"info-content"},Je={class:"info-row"},Ge={class:"info-value"},je={class:"info-row"},qe={class:"info-value"},Ke={class:"info-row"},Ze={key:0,class:"info-value"},Ye={key:1,class:"info-value text-muted"},We={class:"info-row"},Qe={class:"info-value"},Xe=["src"],et=17,at={__name:"AbsensiView",setup(C){const i=de();d(null);const r=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],M=d({ipv4:r[0],ipv6:r[0]}),l=d({lat:r[0],lon:r[0]});d({city:r[0],country:r[0],lat:"",lon:""});const y=d(!1),v=d(""),_=d([]),m=d([]),F=d(!0),I=d(!1),D=d(""),T=d(null);let S=null;const R=U(()=>![l.value.lat,l.value.lon,M.value.ipv4].some(t=>r.includes(t))),V=U(()=>{var t,e;return(((t=v.value)==null?void 0:t.distance)??99999)>((e=v.value)==null?void 0:e.maxDistance)}),w=U(()=>{const t=m.value[0];if(!t)return"IN";const e=t.hour_in?new Date(t.hour_in):null,o=t.hour_out&&t.hour_out!=="00:00:00"?new Date(t.hour_out):null,s=new Date,c=e&&e.getFullYear()===s.getFullYear()&&e.getMonth()===s.getMonth()&&e.getDate()===s.getDate(),n=e?(s-e)/(1e3*60*60):0,f=o?(s-o)/(1e3*60*60):null;return o&&c||o&&f<2?"DONE":o&&(!c||f>=2)||n>=19?"IN":"OUT"}),$=d({photo:null,description:""}),K=async()=>{try{const t=await P.get(`${E}/tools/memo`);$.value.photo=`${ve}/memo/${t.data[0].photo}`,$.value.description=t.data[0].description}catch(t){console.error("Failed to fetch memo:",t)}},Z=async()=>{try{const t=await fetch(`${i.apiBaseUrl}/absensi-status?username=${i.username}`);m.value=await t.json(),m.value.length>0&&(m.value[0].foto_in=`${i.baseUrl}/uploads/absensi/${m.value[0].foto_in}`,m.value[0].foto_out=`${i.baseUrl}/uploads/absensi/${m.value[0].foto_out}`)}catch(t){console.error("Failed to fetch absensi status:",t)}finally{F.value=!1}},Y=()=>new Promise(t=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{l.value.lat=e.coords.latitude.toFixed(6),l.value.lon=e.coords.longitude.toFixed(6),t(!0)},e=>{console.warn("âŒ Geolocation permission denied or error:",e.message),l.value.lat=r[1],l.value.lon=r[1],t(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("âŒ Unexpected GPS error:",e),l.value.lat=r[2],l.value.lon=r[2],t(!1)}else l.value.lat=r[2],l.value.lon=r[2],t(!1)});function W(t,e,o,s){const n=(o-t)*Math.PI/180,f=(s-e)*Math.PI/180,h=Math.sin(n/2)**2+Math.cos(t*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(f/2)**2,k=6371*(2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)))*1e3;return isNaN(k)?0:k.toFixed(2)}const Q=async()=>{try{const t=await P.get(`${E}/hr-lokasi`,{headers:{Authorization:`Bearer ${i.token}`}});_.value=t.data.map(e=>{const o=e.latitude??null,s=e.longitude??null,c=e.maxDistance!=null?parseInt(e.maxDistance,10):null,n=o!==null&&s!==null&&l.value.lat&&l.value.lon?W(l.value.lat,l.value.lon,o,s):1/0;return{nama:e.nama??"",lat:o,lon:s,distance:n,maxDistance:c}}),_.value.sort((e,o)=>e.distance-o.distance),_.value.length>0&&(v.value=_.value[0])}catch(t){console.error("Failed to fetch locations:",t)}},X=async()=>{try{const t=await P.get(`${E}/ip`,{headers:{Authorization:`Bearer ${i.token}`}});M.value.ipv4=t.data.ip}catch(t){console.error("Error fetching IP:",t),M.value.ipv4=r[2]}},z=t=>{D.value=t,I.value=!0},H=()=>{I.value=!1},ee=()=>{if(!v.value){alert("Silakan pilih lokasi absen terlebih dahulu!");return}document.getElementById("cameraInput").click()},te=()=>{const t=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,o=e.match(/\(([^)]+)\)/);let s=o?o[1]:`?${e}`;return s.length>250&&(s=s.substring(0,250)),{dimension:t,device:s}},ae=t=>new Promise(e=>{const o=new FileReader;o.onload=s=>{const c=new Image;c.onload=()=>{const n=document.createElement("canvas"),f=n.getContext("2d");n.width=600,n.height=800;const h=c.width/c.height;let b,k;h>600/800?(k=800,b=800*h):(b=600,k=600/h);const le=(600-b)/2,ie=(800-k)/2;f.drawImage(c,le,ie,b,k),n.toBlob(re=>{e(new File([re],t.name,{type:"image/jpeg",lastModified:Date.now()}))},"image/jpeg",.9)},c.src=s.target.result},o.readAsDataURL(t)}),oe=async t=>{const e=t.target.files[0];if(e)try{const o=await ae(e),{dimension:s,device:c}=te(),n=new FormData;n.append("foto",o),n.append("id",w.value=="IN"?null:m.value[0].id),n.append("status",w.value),n.append("username",i.username),n.append("lokasi",v.value.nama),n.append("jarak",v.value.distance),n.append("long",l.value.lon),n.append("lang",l.value.lat),n.append("ip",M.value.ipv4),n.append("dim",s),n.append("device",c);const h=(await P.post("https://www.transkon-rent.com/api/absensi",n,{headers:{Authorization:`Bearer ${i.token}`,"Content-Type":"multipart/form-data"}})).data;h.status==="success"?(y.value=!0,window.location.reload()):console.error("Attendance failed:",h.message)}catch(o){console.error("Upload error:",o)}},O=d(!1),ne=t=>{D.value=t,O.value=!0},se=()=>{O.value=!1};ue(async()=>{try{const t=await Y();if(await Promise.all([K(),Q(),X(),Z()]),t&&l.value.lat&&l.value.lon){const e=parseFloat(l.value.lat),o=parseFloat(l.value.lon);S=L.map(T.value).setView([e,o],et),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(S),L.marker([e,o]).addTo(S).bindPopup("Lokasi Anda").openPopup()}window.sendUserToFlutter&&(i!=null&&i.id)&&window.sendUserToFlutter(i.id)}catch(t){console.error("ðŸ’¥ Unhandled error in onMounted:",t)}}),pe(()=>{S&&(S.remove(),S=null)});function J(t){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],o=new Date(t),s=o.getDate(),c=e[o.getMonth()],n=o.getFullYear(),f=String(o.getHours()).padStart(2,"0"),h=String(o.getMinutes()).padStart(2,"0"),b=String(o.getSeconds()).padStart(2,"0");return`${s} ${c} ${n} ${f}:${h}:${b}`}return(t,e)=>{var c;const o=G("VButton"),s=G("Button");return p(),u("div",ke,[a("main",Me,[a("h1",Se,"Hi, "+g(me(i).name),1),e[15]||(e[15]=a("p",{class:"app-subtitle"},null,-1)),a("div",De,[a("div",Le,[_.value.length>0?(p(),u("p",$e,g(_.value[0].nama),1)):(p(),u("p",xe,"Loading location..."))]),w.value==="OUT"||w.value==="DONE"?(p(),u("div",Ae,[a("div",null,g(J(m.value[0].hour_in)),1),x(o,{onClick:e[0]||(e[0]=n=>z(m.value[0].foto_in)),class:"btn btn-danger"},{default:B(()=>e[4]||(e[4]=[j("Photo In")])),_:1}),x(q,{imageSrc:D.value,showModal:I.value,onClose:H},null,8,["imageSrc","showModal"])])):A("",!0),w.value==="DONE"?(p(),u("div",Ie,[a("div",null,g(J((c=m.value[0])==null?void 0:c.hour_out)),1),x(o,{onClick:e[1]||(e[1]=n=>z(m.value[0].foto_out)),class:"btn btn-danger"},{default:B(()=>e[5]||(e[5]=[j("Photo Out")])),_:1}),x(q,{imageSrc:D.value,showModal:I.value,onClose:H},null,8,["imageSrc","showModal"])])):A("",!0),a("div",Pe,[a("input",{type:"file",accept:"image/*",capture:"environment",onChange:oe,id:"cameraInput",style:{display:"none"}},null,32),x(s,{onClick:ee,class:"primary-btn",disabled:!v.value||w.value==="DONE"||F.value||!R.value||V.value},{default:B(()=>[e[6]||(e[6]=a("i",{class:"fa-solid fa-camera"},null,-1)),F.value?(p(),u("span",Ce,"Loading...")):R.value?V.value?(p(),u("span",Oe,"Anda Diluar Zona Absensi")):(p(),u("span",Ue,g(w.value==="DONE"?"Sudah Absen":w.value==="OUT"?"Absen Pulang":"Absen Datang"),1)):(p(),u("span",Fe,"Gagal Memuat"))]),_:1},8,["disabled"])]),y.value?(p(),u("div",Be,e[7]||(e[7]=[a("i",{class:"fa-solid fa-check-circle success-icon"},null,-1),a("span",null,"Absensi berhasil direkam!",-1)]))):A("",!0)]),a("div",Ee,[e[8]||(e[8]=a("div",{class:"announcement-header"},[a("i",{class:"fa-solid fa-bullhorn announcement-icon"}),a("h3",null,"TRJA Memo")],-1)),a("div",Ne,[a("img",{src:$.value.photo,alt:"TRJA Memo",class:"announcement-image",onClick:e[2]||(e[2]=n=>ne($.value.photo)),style:{cursor:"pointer"}},null,8,Te),a("p",Re,g($.value.description),1)])]),a("div",Ve,[a("div",ze,[e[13]||(e[13]=a("div",{class:"info-header"},[a("i",{class:"fa-solid fa-map-marker-alt"}),a("h4",null,"Lokasi GPS Anda")],-1)),a("div",He,[a("div",Je,[e[9]||(e[9]=a("span",{class:"info-label"},"Latitude:",-1)),a("span",Ge,g(l.value.lat),1)]),a("div",je,[e[10]||(e[10]=a("span",{class:"info-label"},"Longitude:",-1)),a("span",qe,g(l.value.lon),1)]),a("div",Ke,[e[11]||(e[11]=a("span",{class:"info-label"},"Jarak:",-1)),_.value.length>0?(p(),u("span",Ze,g(_.value[0].distance+" Meter"),1)):(p(),u("span",Ye," Menghitung Jarak.. "))]),a("div",We,[e[12]||(e[12]=a("span",{class:"info-label"},"IPv4:",-1)),a("span",Qe,g(M.value.ipv4),1)]),a("div",{ref_key:"gpsMapContainer",ref:T,class:"map-container-leaflet"},null,512)])]),e[14]||(e[14]=a("p",null,[a("span",{style:{color:"red","font-size":"10px"}}," *Segala bentuk kecurangan pencatatan kehadiran dapat terdeteksi dan akan ditindaklanjuti ")],-1))]),O.value?(p(),u("div",{key:0,class:"memo-overlay",onClick:se},[a("img",{src:D.value,onClick:e[3]||(e[3]=N(()=>{},["stop"]))},null,8,Xe)])):A("",!0)])])}}};export{at as default};
