import{_ as M,u as $,r as b,o as z,w as F,l as C,c,g as i,a as d,F as E,j as O,m as I,b as q,t as P,C as A,y as R,v as T,p as N,s as _,A as G}from"./index-CLASJnMc.js";import{s as B}from"./vue-multiselect-Cj3hf3ZL.js";const H={class:"container-global mb-4"},J={key:0},K={class:"form-grid"},Q=["value"],W=["value","onInput"],X=["value","onInput"],Y={key:5,class:"checkbox-field no-border"},Z=["checked","onChange"],ee=["onUpdate:modelValue","placeholder"],le={key:1,class:"loading-message"},te={__name:"MiniForm",props:{modelValue:{type:Object,default:()=>({})},fields:Object,urls:Object},emits:["update:modelValue"],setup(U,{emit:S}){const v=$(),r=U,g=S,o=b({...r.modelValue}),y=b({}),k=b(!1),j=async()=>{localStorage.getItem("token");const a=Object.entries(r.urls.dropdowns).map(async([t,e])=>{try{const s=await _.get(e.url,{headers:{Authorization:`Bearer ${v.token}`}});y.value[t]=s.data.map(l=>({label:l,value:l}))}catch(s){console.error(`Failed to fetch dropdown data for ${t}:`,s)}});await Promise.all(a),k.value=!0};z(async()=>{await j()}),F(()=>r.modelValue,a=>{o.value={...a}});const m=async(a,t)=>{o.value[a]=t,g("update:modelValue",{...o.value}),r.fields.columns.forEach(async e=>{if(e.autofill&&e.autofill.triggeredBy===a)try{const s=await _.get(G+"/"+e.autofill.url,{headers:{Authorization:`Bearer ${v.token}`},params:[t.label]}),l=e.autofill.getValue(s.data);o.value[e.column]=l,g("update:modelValue",{...o.value})}catch(s){console.error(`Failed to autofill ${e.column}:`,s),o.value[e.column]=""}})},D=a=>{var t;return(t=r.fields.uneditable)==null?void 0:t.includes(a.column)},p=(a,t)=>{var e;return(e=r.fields[a])==null?void 0:e.includes(t.column)},L=async()=>{var a,t;try{const e={};for(const l of r.fields.columns||[]){const u=l.column;if((a=r.fields.toRemove)!=null&&a.includes(u)||(t=r.fields.exclude)!=null&&t.includes(u))continue;if(l.compute){e[u]=l.compute(o.value),typeof e[u]=="boolean"&&(e[u]=e[u]?1:0);continue}if(!(typeof l.visibleIf=="function"?l.visibleIf(o.value):!0))continue;const n=o.value[u],w=l.required??!1,x=n==null||typeof n=="string"&&n.trim()===""||Array.isArray(n)&&n.length===0&&typeof n!="boolean";if(w&&x){alert(`Field "${l.label||u}" is required.`);return}!w&&x||(Array.isArray(n)?e[u]=n.map(f=>(f==null?void 0:f.label)??f).join(","):typeof n=="object"&&"label"in n?e[u]=n.label:typeof n=="boolean"?e[u]=n?1:0:e[u]=n)}e.username=v.username,console.log("payload:",e);const s=await _.post(r.urls.data,e,{headers:{Authorization:`Bearer ${token}`}});window.location.reload(),console.log("Form submitted successfully:",s.data)}catch(e){console.error("Failed to submit form:",e)}},h=C(()=>r.fields.columns.filter(a=>typeof a.visibleIf=="function"?a.visibleIf(o.value):!0)),V=b(h.value);return F(h,a=>{const t=a.map(s=>s.column);V.value.filter(s=>!t.includes(s)).forEach(s=>{m(s,null)}),V.value=t},{immediate:!0}),(a,t)=>(i(),c("div",H,[k.value?(i(),c("div",J,[d("form",{onSubmit:N(L,["prevent"]),class:"mini-form"},[d("div",K,[(i(!0),c(E,null,O(h.value,(e,s)=>(i(),c("div",{key:e.column,class:"form-field"},[d("label",null,P(e.label),1),D(e)?(i(),c("input",{key:0,type:"text",class:"input bordered",value:o.value[e.column],disabled:""},null,8,Q)):p("datetime",e)?(i(),c("input",{key:1,type:"datetime-local",class:"input bordered",value:o.value[e.column]||"",onInput:l=>m(e.column,l.target.value)},null,40,W)):p("number",e)?(i(),c("input",{key:2,type:"number",class:"input bordered",value:o.value[e.column]||"",onInput:l=>m(e.column,l.target.value)},null,40,X)):p("dropdown",e)?(i(),I(A(B),{key:3,modelValue:o.value[e.column],"onUpdate:modelValue":[l=>o.value[e.column]=l,l=>m(e.column,l)],options:y.value[e.column]||[],placeholder:"Select",label:"label","track-by":"value",class:"multiselect no-border"},null,8,["modelValue","onUpdate:modelValue","options"])):p("multiselect",e)?(i(),I(A(B),{key:4,modelValue:o.value[e.column],"onUpdate:modelValue":[l=>o.value[e.column]=l,l=>m(e.column,l)],options:y.value[e.column]||[],placeholder:"Select",label:"label","track-by":"value",class:R(["multiselect no-border",{"multiselect--multiple":p("multiselect",e)}]),multiple:"true","close-on-select":!1},null,8,["modelValue","onUpdate:modelValue","options","class"])):p("checkbox",e)?(i(),c("div",Y,[d("input",{type:"checkbox",checked:o.value[e.column],onChange:l=>m(e.column,l.target.checked),class:"form-checkbox"},null,40,Z)])):q((i(),c("input",{key:6,type:"text",class:"form-input bordered","onUpdate:modelValue":l=>o.value[e.column]=l,placeholder:e.filterText||e.label},null,8,ee)),[[T,o.value[e.column]]])]))),128))]),t[0]||(t[0]=d("div",{class:"submit-container"},[d("button",{type:"submit",class:"submit-button bordered"},"Submit")],-1))],32)])):(i(),c("div",le,t[1]||(t[1]=[d("i",{class:"pi pi-spin pi-spinner",style:{"font-size":"1.5rem"}},null,-1),d("p",null,"Loading form...",-1)])))]))}},ne=M(te,[["__scopeId","data-v-d9bfdeb8"]]);export{ne as M};
