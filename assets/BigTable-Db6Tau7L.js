import{u as _e,r as i,o as ye,D as xe,c as d,g as s,a as _,n as w,t as E,m as V,f as F,b as R,C as I,v as T,d as ke,h as te,V as le,s as z,l as Ce}from"./index-BvCZzanR.js";import{V as ae,u as M,w as $e}from"./xlsx-BtEiuvS5.js";/* empty css                            */import{s as oe}from"./vue-multiselect-8dhHIRLL.js";import{l as ne}from"./logger-B1IqVKgO.js";/* empty css                                                 */const Ve={class:"container-global mb-4"},Ie={key:2},Ue={key:3,class:"error"},pe={class:"table-container"},Ne={key:0,class:"checkbox-container"},De=["checked","onClick"],Se=["onUpdate:modelValue","onInput"],Oe=["value","onInput"],Ee=["onUpdate:modelValue","onInput"],Fe={key:5},Re={class:"mb-2"},Te={class:"table-container"},ze={key:0,class:"checkbox-container"},Be=["checked","onClick"],je=["onUpdate:modelValue","onInput"],Ae=["value","onInput"],Le=["onUpdate:modelValue","onInput"],Me={key:5},Qe={__name:"BigTable",props:{settings:{type:Object,required:!0},urls:{type:Object,required:!0},fields:{type:Object,required:!0},canInsert:{type:Boolean,default:!0},canUpdate:{type:Boolean,default:!0}},setup(ue,{expose:se}){const B=_e(),y=ue,j=i(),c=i(),o=i(),U=i(),p=i();j.value=y.settings,c.value=y.urls,o.value=y.fields,U.value=y.canInsert,p.value=y.canUpdate;const A=j.value.size??[10,20,100];Array.isArray(o.value.toRemove)?o.value.toRemove.push("isEditing","filterable","vgt_id","originalIndex"):o.value.toRemove=["isEditing","filterable","vgt_id","originalIndex"];const r=i({data:[],dropdowns:[]}),N=i([]);let W=i([]);const D=i([]),x=i([]),h=i(!0),k=i(null);i("150px");const K=i("100px"),C=i(new Map),$=i(new Map);let q=c.value.data;if(c.value.params){const l=new URLSearchParams(c.value.params).toString();q+=`?${l}`}const ie=async()=>{const l=Object.keys(c.value.dropdowns);for(const a of l){const e=c.value.dropdowns[a].url,t=c.value.dropdowns[a].valueField,u=c.value.dropdowns[a].labelField;try{const v=await z.get(e,{headers:{Authorization:`Bearer ${B.token}`}});r.value.dropdowns[u]=v.data.map(S=>S[t]??"")}catch(v){console.error(`Failed to fetch ${a} data from ${e}:`,v)}}},P=async()=>{try{h.value=!0;const l=await z.get(q,{headers:{Authorization:`Bearer ${B.token}`}});if(l.data.length>0){const a=o.value.priority||[],e=o.value.toRemove||[],t=o.value.unpriority||[],u=Object.keys(l.data[0]),v=a.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!t.includes(n)),S=t.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!v.includes(n)),he=u.filter(n=>!v.includes(n)&&!S.includes(n)&&n!==o.value.firstCol.field&&!e.includes(n)&&!o.value.hidden.includes(n)),be=[...v,...he,...S];N.value=[{label:o.value.firstCol.label,field:o.value.firstCol.field,width:`${o.value.firstCol.width??80}px`,minWidth:"100px",sortable:!0,filterable:!1,editable:!1,frozen:!0,type:o.value.firstCol.type,headerClass:"custom-header"},...o.value.status?[{label:o.value.status.label??o.value.status.field.toUpperCase(),field:o.value.status.field,sortable:!1,filterable:!0,filterOptions:{enabled:!0,placeholder:"status"},editable:!1,type:"text",width:`${o.value.status.width??120}px`,minWidth:"100px",headerClass:"custom-header"}]:[],...be.map(n=>{var X,Y,Z,O,ee;const Q=o.value.checkbox.includes(n),we=!Q&&l.data.every(b=>{const ge=b[n];return!isNaN(Number(ge))}),g=(Y=(X=o.value)==null?void 0:X.columns)==null?void 0:Y.find(b=>b.column===n);return{label:n.replace(/_/g," ").toUpperCase(),field:n,sortable:!0,filterable:!0,filterOptions:{enabled:!0,placeholder:`${n}`},editable:p.value&&!((ee=(O=(Z=o.value)==null?void 0:Z.uneditable)==null?void 0:O.includes)!=null&&ee.call(O,n)),type:Q?"checkbox":we?"number":"text",width:`${(g==null?void 0:g.width)??Math.max(...l.data.map(b=>String((b==null?void 0:b[n])??"").length),n.length)*A[0]+A[1]}px`,minWidth:`${(g==null?void 0:g.minWidth)??A[2]}px`,headerClass:"custome-header"}})]}W=Ce(()=>N.value.map(a=>({...a,filterOptions:{enabled:!1},sortable:!1}))),r.value.data=l.data.map(a=>({...a,filterable:!0})),r.value.data=l.data.map(a=>{const e={};for(const t in a){const u=a[t];if(u==null)e[t]=u;else{const v=Number(u);e[t]=isNaN(v)?String(u):v}}return o.value.status&&o.value.status.calculate&&(e.status=o.value.status.calculate(a)),e.filterable=!0,e}),x.value=[...r.value.data],setTimeout(L,500)}catch(l){k.value="Failed to fetch data",console.error(l)}finally{h.value=!1,G()}},G=()=>{const l={};N.value.forEach(a=>{l[a.field]=o.value.checkbox.includes(a.field)?0:""}),l.id=D.value.length+1,D.value.push(l)},f=(l,a)=>{$.value.has(l.id)?$.value.get(l.id)[a]=l[a]:$.value.set(l.id,{...l})},de=async()=>{try{const l=Array.from($.value.values());for(const a of l){const e={...a};for(const t of o.value.toRemove)delete e[t];delete e.id,o.value.date.forEach(t=>{e[t]!==null&&e[t]!==void 0&&!isNaN(Date.parse(e[t]))&&(e[t]=new Date(e[t]).toISOString().split("T")[0])}),Object.keys(e).forEach(t=>{e[t]===""&&(e[t]=null)}),await z.post(c.value.data,e,{headers:{Authorization:`Bearer ${token}`}}),await P(),D.value=[],$.value.clear(),window.location.reload()}}catch(l){console.error("Failed to upload: ",l),alert("Failed to upload")}},m=(l,a)=>{C.value.has(l.id)?C.value.get(l.id)[a]=l[a]:C.value.set(l.id,{...l})},ce=async()=>{const l=Array.from(C.value.values()),a=[];for(const e of l)try{const t=Object.fromEntries(Object.entries(e).filter(([u])=>!o.value.exclude.includes(u)&&!o.value.toRemove.includes(u)));o.value.date.forEach(u=>{t[u]!==null&&t[u]!==void 0&&!isNaN(Date.parse(t[u]))&&(t[u]=new Date(t[u]).toISOString().split("T")[0])}),await z.put(c.value.data,t,{headers:{Authorization:`Bearer ${B.token}`}})}catch(t){console.error("Failed to update row:",e.id,t),a.push(e.id)}a.length>0?alert(`Some rows failed to save: ${a.join(", ")}`):(alert("Changes saved successfully!"),window.location.reload(),C.value.clear())},re=()=>{const l=M.json_to_sheet(x.value),a=M.book_new();M.book_append_sheet(a,l,"Marketing Data"),$e(a,"Filtered_Marketing_Data.xlsx")},fe=l=>{x.value=l,ne("Length : "+x.value.length),ne("onTableFiltered : ",x.value)},L=()=>{const l=document.querySelector(".vue-good-table th:nth-child(1)");l&&(K.value=l.offsetWidth+"px"),document.documentElement.style.setProperty("--second-column-width",K.value)};se({datas:r,loading:h,getLoading:()=>h.value}),ye(()=>{ie(),P(),window.addEventListener("resize",L)}),xe(()=>{window.removeEventListener("resize",L)});const H=l=>{if(l){const[a,e]=l.split(" ");return`${a}T${e.slice(0,5)}`}return""},J=l=>{if(l){const[a,e]=l.split("T"),t=`${e}:00`;return`${a} ${t}`}return""},me=(l,a,e)=>{a[e]=J(l.target.value),m(a,e)},ve=(l,a,e)=>{a[e]=J(l.target.value),f(a,e)};return i(!1),(l,a)=>(s(),d("div",Ve,[_("h2",null,E(j.value.title),1),U.value?(s(),d("button",{key:0,onClick:de},"Upload")):w("",!0),U.value?(s(),d("button",{key:1,onClick:G},"Add New Row")):w("",!0),h.value?(s(),d("p",Ie,"Loading...")):w("",!0),k.value?(s(),d("p",Ue,E(k.value),1)):w("",!0),_("div",pe,[!h.value&&!k.value&&U.value?(s(),V(I(ae),{key:0,columns:I(W),rows:D.value,"search-options":{enabled:!1},"sort-options":{enabled:!1},"line-numbers":!1,"select-options":{enabled:!1},"pagination-options":{enabled:!1},style:{"overflow-x":"auto"}},{"table-row":F(e=>[o.value.checkbox.includes(e.column.field)?(s(),d("div",Ne,[_("input",{type:"checkbox",name:"custom-checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,f(e.row,e.column.field)}},null,8,De)])):Object.keys(r.value.dropdowns).includes(e.column.field)?(s(),V(I(oe),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(f==null?void 0:f(e.row,e.column.field))||(m==null?void 0:m(e.row,e.column.field))],options:r.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?R((s(),d("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>f(e.row,e.column.field)},null,40,Se)),[[T,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),d("input",{key:3,type:"datetime-local",value:H(e.row[e.column.field]),onInput:t=>ve(t,e.row,e.column.field)},null,40,Oe)):e.column.editable!==!1?R((s(),d("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>f(e.row,e.column.field)},null,40,Ee)),[[T,e.row[e.column.field]]]):(s(),d("span",Fe,E(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):w("",!0)]),_("div",Re,[ke(le,{onClick:re,type:"submit",color:"danger",size:"md",block:!1,class:"me-2"},{default:F(()=>a[0]||(a[0]=[te("Export to Excel")])),_:1}),p.value?(s(),V(le,{key:0,onClick:ce,type:"submit",color:"danger",size:"md",block:!1},{default:F(()=>a[1]||(a[1]=[te("Save Updates")])),_:1})):w("",!0)]),_("div",Te,[!h.value&&!k.value?(s(),V(I(ae),{key:0,columns:N.value,rows:r.value.data,"pagination-options":{enabled:!0,mode:"pages",perPage:10},"search-options":{enabled:!0},"sort-options":{enabled:!0},style:{"overflow-x":"auto"},onOnFiltered:fe,styleClass:"vgt-table striped"},{"table-row":F(e=>[o.value.checkbox.includes(e.column.field)?(s(),d("div",ze,[_("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,m(e.row,e.column.field)}},null,8,Be)])):Object.keys(r.value.dropdowns).includes(e.column.field)&&p.value?(s(),V(I(oe),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>(f==null?void 0:f(e.row,e.column.field))||(m==null?void 0:m(e.row,e.column.field))],options:r.value.dropdowns[e.column.field]||[],searchable:!0,"allow-empty":!1,placeholder:`Select ${e.column.field}`,noResultsText:"No matching results"},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?R((s(),d("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,je)),[[T,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(s(),d("input",{key:3,type:"datetime-local",value:H(e.row[e.column.field]),onInput:t=>me(t,e.row,e.column.field)},null,40,Ae)):e.column.editable!==!1?R((s(),d("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>m(e.row,e.column.field)},null,40,Le)),[[T,e.row[e.column.field]]]):(s(),d("span",Me,E(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])):w("",!0)])]))}};export{Qe as _};
