import{u as X,r as _,D as E,n as Y,o as Z,c as r,a as e,b as V,k as U,F as f,j as D,d as ee,i as te,l as ae,q as h,h as R,t as n,z as v,p as x,A as C,g as i}from"./index-Cq0ZFpcm.js";const se={class:"approval-queue-container"},le={class:"filter-controls mb-4"},ne={class:"row"},oe={class:"col-md-3"},re=["value"],ie={class:"col-md-3"},de={class:"col-md-3"},ue={class:"card"},ce={class:"card-body"},pe={key:0,class:"text-center py-4"},me={key:1,class:"table-responsive"},ge={class:"table table-hover"},ve={class:"d-flex align-items-center"},be=["src"],ye={class:"text-muted"},_e={class:"badge bg-secondary"},fe=["onClick"],he=["onClick","disabled"],ke=["onClick","disabled"],we={key:0},Pe={colspan:"8",class:"text-center text-muted py-4"},Ae={class:"d-flex justify-content-between align-items-center mt-3"},De={class:"text-muted"},Re={class:"pagination"},xe=["onClick"],Ce={class:"modal",id:"approvalDetailsModal",tabindex:"-1","data-bs-backdrop":"false","data-bs-keyboard":"false",style:{"z-index":"1060"}},$e={class:"modal-dialog modal-lg"},je={class:"modal-content"},Se={class:"modal-header"},Te={class:"modal-title"},qe={key:0,class:"modal-body"},Le={class:"row mb-4"},Me={class:"col-md-6"},Be={class:"list-group list-group-flush"},Ie={class:"list-group-item"},ze={class:"list-group-item"},Ee={class:"list-group-item"},Ve={class:"list-group-item"},Ue={class:"col-md-6"},Ne={class:"d-flex align-items-center mb-3"},Fe=["src"],Ge={class:"mb-0"},He={class:"text-muted mb-0"},Je={class:"text-muted mb-0"},Oe={class:"mb-4"},Qe={class:"card"},Ke={class:"card-body"},We={class:"mb-0"},Xe={key:0},Ye={class:"d-flex flex-wrap gap-2"},Ze={class:"d-flex align-items-center"},et={class:"text-muted"},tt=["href"],at={class:"modal-footer"},nt={__name:"Approval",setup(st){const m=X(),b=_([]),y=_(!1),o=_(null),N=_(null),P=_(null),$=_("/default.jpeg"),u=E({type:"",department:"",dateRange:null}),j=[{value:"izin",label:"Izin Tidak Masuk"},{value:"datang telat",label:"Datang Terlambat"},{value:"pulang cepat",label:"Pulang Cepat"},{value:"cuti",label:"Cuti"},{value:"dinas",label:"Perjalanan Dinas"}],l=E({currentPage:1,perPage:10,total:0,start:0,end:0,totalPages:0,pages:[]}),F=async()=>{try{y.value=!0;const s=await x.get(`${C}/api.php`,{params:{request:"jabatan"},headers:{Authorization:`Bearer ${m.token}`}}),{jabatan:t}=s.data;if(!t)throw new Error("Jabatan tidak ditemukan");P.value={jabatan:t},await A()}catch(s){console.error("Gagal ambil jabatan:",s),alert("Gagal ambil jabatan. Login ulang.")}finally{y.value=!1}},A=async()=>{var s,t,d;if((s=P.value)!=null&&s.jabatan)try{y.value=!0;const c=await x.get(`${C}/api.php`,{params:{request:"get-pending-approvals",role:P.value.jabatan,username:m.username},headers:{Authorization:`Bearer ${m.token}`}});b.value=Array.isArray((t=c.data)==null?void 0:t.data)?c.data.data:[],b.value.length===0&&console.warn("No pending approvals found for role:",P.value.jabatan)}catch(c){console.error("Error details:",((d=c.response)==null?void 0:d.data)||c.message),b.value=[]}finally{y.value=!1}},S=async s=>{const t=prompt("Komentar (opsional):","");try{await x.post(`${C}/api.php`,new URLSearchParams({request:"approval-action",action:"approve",request_id:s,username:m.username,comment:t||""}),{headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"application/x-www-form-urlencoded"}}),alert("Approved!"),A()}catch(d){alert("Gagal approve: "+d.message)}},T=async s=>{const t=prompt("Alasan penolakan:","");if(!t)return alert("Wajib isi alasan");try{await x.post(`${C}/api.php`,new URLSearchParams({request:"approval-action",action:"reject",request_id:s,username:m.username,comment:t}),{headers:{Authorization:`Bearer ${m.token}`,"Content-Type":"application/x-www-form-urlencoded"}}),alert("Rejected!"),A()}catch(d){alert("Gagal reject: "+d.message)}},G=s=>{o.value={...s};const t=new bootstrap.Modal(document.getElementById("approvalDetailsModal"),{backdrop:!1,keyboard:!1});t.show(),document.getElementById("approvalDetailsModal").addEventListener("click",d=>{d.target===document.getElementById("approvalDetailsModal")&&t.hide()})},k=()=>{l.currentPage=1},H=()=>{u.type="",u.department="",u.dateRange=null,k()},q=Y(()=>{var w;let t=Array.isArray(b.value)?b.value:[];if(u.type&&(t=t.filter(p=>p.type===u.type)),u.department&&(t=t.filter(p=>{var a;return((a=p.requester)==null?void 0:a.department)===u.department})),((w=u.dateRange)==null?void 0:w.length)===2){const[p,a]=u.dateRange;t=t.filter(g=>{const z=new Date(g.createdAt);return z>=new Date(p)&&z<=new Date(a)})}const d=t.length;l.total=d,l.totalPages=Math.ceil(d/l.perPage),l.start=d?(l.currentPage-1)*l.perPage+1:0,l.end=Math.min(l.start+l.perPage-1,d),l.pages=Array.from({length:l.totalPages},(p,a)=>a+1);const c=(l.currentPage-1)*l.perPage;return t.slice(c,c+l.perPage)}),J=()=>l.currentPage>1&&l.currentPage--,O=()=>l.currentPage<l.totalPages&&l.currentPage++,Q=s=>s!==l.currentPage&&(l.currentPage=s);Z(()=>{const s=document.getElementById("approvalDetailsModal");s&&(N.value=new bootstrap.Modal(s)),F()});const L=s=>`REQ-${String(s).padStart(6,"0")}`,M=s=>{var t;return((t=j.find(d=>d.value===s))==null?void 0:t.label)||s},B=s=>({izin:"danger","datang telat":"info","pulang cepat":"warning",cuti:"primary",dinas:"success"})[s]||"secondary",I=s=>({pending:"warning",approved:"success",rejected:"danger"})[s]||"secondary",K=s=>new Date(s).toLocaleDateString(),W=s=>new Date(s).toLocaleString();return(s,t)=>{var c,w,p;const d=te("date-picker");return i(),r("div",se,[t[27]||(t[27]=e("div",{class:"page-header"},[e("h2",{class:"page-title"},"Approval Queue"),e("p",{class:"page-subtitle"},"Pending approvals waiting for your action")],-1)),e("div",le,[e("div",ne,[e("div",oe,[t[6]||(t[6]=e("label",{class:"form-label"},"Request Type",-1)),V(e("select",{"onUpdate:modelValue":t[0]||(t[0]=a=>u.type=a),class:"form-select",onChange:k},[t[5]||(t[5]=e("option",{value:""},"All Types",-1)),(i(),r(f,null,D(j,a=>e("option",{value:a.value,key:a.value},n(a.label),9,re)),64))],544),[[U,u.type]])]),e("div",ie,[t[7]||(t[7]=e("label",{class:"form-label"},"Date Range",-1)),ee(d,{modelValue:u.dateRange,"onUpdate:modelValue":[t[1]||(t[1]=a=>u.dateRange=a),k],range:"",placeholder:"Select date range",class:"w-100"},null,8,["modelValue"])]),e("div",de,[t[9]||(t[9]=e("label",{class:"form-label"},"Department",-1)),V(e("select",{"onUpdate:modelValue":t[2]||(t[2]=a=>u.department=a),class:"form-select",onChange:k},t[8]||(t[8]=[ae('<option value="">All Departments</option><option value="IT">IT</option><option value="Marketing">Marketing</option><option value="HR">HR</option><option value="Finance">Finance</option><option value="Operations">Operations</option><option value="Legal">Legal</option><option value="Production">Production</option>',8)]),544),[[U,u.department]])]),e("div",{class:"col-md-3 d-flex align-items-end"},[e("button",{onClick:H,class:"btn btn-outline-secondary me-2"},"Reset"),e("button",{onClick:k,class:"btn btn-primary"},"Apply Filters")])])]),e("div",ue,[e("div",ce,[y.value?(i(),r("div",pe,t[10]||(t[10]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)]))):(i(),r("div",me,[e("table",ge,[t[14]||(t[14]=e("thead",null,[e("tr",null,[e("th",null,"Request ID"),e("th",null,"Type"),e("th",null,"Requester"),e("th",null,"Date"),e("th",null,"Status"),e("th",null,"Step"),e("th",null,"Details"),e("th",null,"Actions")])],-1)),e("tbody",null,[(i(!0),r(f,null,D(q.value,a=>(i(),r("tr",{key:a.id},[e("td",null,n(L(a.id)),1),e("td",null,[e("span",{class:v(["badge",`bg-${B(a.type)}`])},n(M(a.type)),3)]),e("td",null,[e("div",ve,[e("img",{src:a.requester.avatar||$.value,class:"rounded-circle me-2",width:"30",height:"30",alt:"User"},null,8,be),e("div",null,[e("div",null,n(a.requester.name),1),e("small",ye,n(a.requester.department),1)])])]),e("td",null,n(K(a.createdAt)),1),e("td",null,[e("span",{class:v(["badge",`bg-${I(a.status)}`])},n(a.status),3)]),e("td",null,[e("span",_e,n(a.current_step)+" of "+n(a.total_steps),1)]),e("td",null,[e("button",{onClick:g=>G(a),class:"btn btn-sm btn-outline-primary"}," View Details ",8,fe)]),e("td",null,[e("button",{onClick:g=>S(a.id),class:"btn btn-sm btn-success me-2",disabled:a.status!=="pending"}," Approve ",8,he),e("button",{onClick:g=>T(a.id),class:"btn btn-sm btn-danger",disabled:a.status!=="pending"}," Reject ",8,ke)])]))),128)),q.value.length===0?(i(),r("tr",we,[e("td",Pe,[y.value?(i(),r(f,{key:0},[t[11]||(t[11]=e("div",{class:"spinner-border spinner-border-sm",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)),t[12]||(t[12]=R(" Loading approvals... "))],64)):(i(),r(f,{key:1},[t[13]||(t[13]=R(" No pending approvals found ")),b.value.length===0?(i(),r("button",{key:0,onClick:A,class:"btn btn-sm btn-link"}," Try again ")):h("",!0)],64))])])):h("",!0)])])])),e("div",Ae,[e("div",De," Showing "+n(l.start)+" to "+n(l.end)+" of "+n(l.total)+" entries ",1),e("nav",null,[e("ul",Re,[e("li",{class:v(["page-item",{disabled:l.currentPage===1}])},[e("button",{class:"page-link",onClick:J},"Previous")],2),(i(!0),r(f,null,D(l.pages,a=>(i(),r("li",{key:a,class:v(["page-item",{active:a===l.currentPage}])},[e("button",{class:"page-link",onClick:g=>Q(a)},n(a),9,xe)],2))),128)),e("li",{class:v(["page-item",{disabled:l.currentPage===l.totalPages}])},[e("button",{class:"page-link",onClick:O},"Next")],2)])])])])]),e("div",Ce,[e("div",$e,[e("div",je,[e("div",Se,[e("h5",Te,"Approval Request #"+n(L((c=o.value)==null?void 0:c.id)),1),t[15]||(t[15]=e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"},null,-1))]),o.value?(i(),r("div",qe,[e("div",Le,[e("div",Me,[t[20]||(t[20]=e("h6",null,"Request Information",-1)),e("ul",Be,[e("li",Ie,[t[16]||(t[16]=e("strong",null,"Type:",-1)),e("span",{class:v(["badge ms-2",`bg-${B(o.value.type)}`])},n(M(o.value.type)),3)]),e("li",ze,[t[17]||(t[17]=e("strong",null,"Status:",-1)),e("span",{class:v(["badge ms-2",`bg-${I(o.value.status)}`])},n(o.value.status),3)]),e("li",Ee,[t[18]||(t[18]=e("strong",null,"Step:",-1)),R(" "+n(o.value.current_step)+" of "+n(o.value.total_steps),1)]),e("li",Ve,[t[19]||(t[19]=e("strong",null,"Date Submitted:",-1)),R(" "+n(W(o.value.createdAt)),1)])])]),e("div",Ue,[t[21]||(t[21]=e("h6",null,"Requester Information",-1)),e("div",Ne,[e("img",{src:o.value.requester.avatar||$.value,class:"rounded-circle me-3",width:"50",height:"50",alt:"User"},null,8,Fe),e("div",null,[e("h6",Ge,n(o.value.requester.name),1),e("p",He,n(o.value.requester.department),1),e("p",Je,n(o.value.requester.email),1)])])])]),e("div",Oe,[t[22]||(t[22]=e("h6",null,"Request Details",-1)),e("div",Qe,[e("div",Ke,[e("pre",We,n(o.value.details),1)])])]),o.value.attachments.length>0?(i(),r("div",Xe,[t[25]||(t[25]=e("h6",null,"Attachments",-1)),e("div",Ye,[(i(!0),r(f,null,D(o.value.attachments,(a,g)=>(i(),r("div",{key:g,class:"border rounded p-2"},[e("div",Ze,[t[24]||(t[24]=e("i",{class:"far fa-file-alt me-2"},null,-1)),e("div",null,[e("div",null,n(a.name),1),e("small",et,n(a.size),1)]),e("a",{href:`/uploads/perizinan/${a.name}`,class:"btn btn-sm btn-outline-primary ms-3",target:"_blank"},t[23]||(t[23]=[e("i",{class:"fas fa-download"},null,-1)]),8,tt)])]))),128))])])):h("",!0)])):h("",!0),e("div",at,[t[26]||(t[26]=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"Close",-1)),((w=o.value)==null?void 0:w.status)==="pending"?(i(),r("button",{key:0,type:"button",class:"btn btn-success",onClick:t[3]||(t[3]=a=>S(o.value.id))}," Approve ")):h("",!0),((p=o.value)==null?void 0:p.status)==="pending"?(i(),r("button",{key:1,type:"button",class:"btn btn-danger",onClick:t[4]||(t[4]=a=>T(o.value.id))}," Reject ")):h("",!0)])])])])])}}};export{nt as default};
