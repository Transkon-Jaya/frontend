import{u as ye,r as c,n as xe,o as ke,J as pe,c as d,g as i,a as V,q as b,t as B,K as E,f as _,h as F,V as T,d as J,b as A,y as K,v as L,p as M}from"./index-B_uv-FNL.js";import{V as ne}from"./vue-good-table.esm-AjkBWcT-.js";/* empty css                            */import{s as se}from"./vue-multiselect-CtpYavXI.js";import{u as Q,w as Ce}from"./xlsx-D1NZSDnX.js";import{a as Ue}from"./logger-DsocdAuK.js";/* empty css                                                 */const $e={class:"container-global mb-4"},Ie={class:"table-title"},Ve={class:"table-actions mb-3"},Ee={key:0},Re={key:1,class:"error"},Ne={key:2,class:"table-container insert-table"},Oe={key:0,class:"checkbox-container"},Se=["checked","onClick"],ze=["onUpdate:modelValue","onInput"],De=["value","onInput"],je=["onUpdate:modelValue","onInput"],Be={key:5},Fe={class:"table-actions mb-3"},Te={key:3,class:"table-container main-table"},Ae={key:0,class:"checkbox-container"},Ke=["checked","onClick"],Le=["onUpdate:modelValue","onInput"],Me=["value","onInput"],We=["onUpdate:modelValue","onInput"],qe={key:5},Ze={__name:"BigTable",props:{settings:{type:Object,required:!0},urls:{type:Object,required:!0},fields:{type:Object,required:!0},canInsert:{type:Boolean,default:!0},canUpdate:{type:Boolean,default:!0}},setup(ue,{expose:ie}){const R=ye(),X=c(!1),ce=c(null),y=ue,W=c(y.settings),r=c(y.urls),o=c(y.fields),q=c(y.canInsert),P=c(y.canUpdate),G=W.value.size??[10,20,100];Array.isArray(o.value.toRemove)?o.value.toRemove.push("isEditing","filterable","vgt_id","originalIndex"):o.value.toRemove=["isEditing","filterable","vgt_id","originalIndex"];const v=c({data:[],dropdowns:[]}),N=c([]),de=xe(()=>N.value.map(a=>({...a,filterOptions:{enabled:!1},sortable:!1}))),O=c([]),x=c([]),k=c(!0),p=c(null),C=c(new Map),U=c(new Map),re=()=>{let a=r.value.data;const l=new URLSearchParams;return r.value.params&&r.value.params.forEach(e=>{e!=null&&l.append("params",e)}),r.value.filters&&Object.entries(r.value.filters).forEach(([e,t])=>{t!=null&&l.append(e,t)}),l.toString()?`${a}?${l}`:a},S=async()=>{try{k.value=!0;const a=re(),l=await M.get(a,{headers:{Authorization:`Bearer ${R.token}`}});if(l.data.length>0){const e=o.value.priority||[],t=o.value.toRemove||[],s=o.value.unpriority||[],u=Object.keys(l.data[0]),f=e.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!t.includes(n)&&!s.includes(n)),z=s.filter(n=>u.includes(n)&&n!==o.value.firstCol.field&&!t.includes(n)&&!f.includes(n)),D=u.filter(n=>{var m;return!f.includes(n)&&!z.includes(n)&&n!==o.value.firstCol.field&&!t.includes(n)&&!((m=o.value.hidden)!=null&&m.includes(n))}),w=[...f,...D,...z];N.value=[{label:o.value.firstCol.label,field:o.value.firstCol.field,width:`${o.value.firstCol.width??150}px`,minWidth:"150px",sortable:!0,filterable:!1,editable:!1,type:o.value.firstCol.type,headerClass:"frozen-col text-center",cellClass:"frozen-cell text-center"},...o.value.status?[{label:o.value.status.label??o.value.status.field.toUpperCase(),field:o.value.status.field,width:`${o.value.status.width??120}px`,minWidth:"120px",sortable:!1,filterable:!0,editable:!1,type:"text",headerClass:"frozen-col status-col text-center",cellClass:"frozen-cell status-cell text-center"}]:[],...w.map(n=>{var te,le,ae,j,oe;const m=o.value.checkbox.includes(n),_e=!m&&l.data.every(h=>!isNaN(Number(h[n]))),g=(le=(te=o.value)==null?void 0:te.columns)==null?void 0:le.find(h=>h.column===n);return{label:n.replace(/_/g," ").toUpperCase(),field:n,sortable:!0,filterable:!0,filterOptions:{enabled:!0,placeholder:n},editable:P.value&&!((oe=(j=(ae=o.value)==null?void 0:ae.uneditable)==null?void 0:j.includes)!=null&&oe.call(j,n)),type:m?"checkbox":_e?"number":"text",width:`${(g==null?void 0:g.width)??Math.max(...l.data.map(h=>String((h==null?void 0:h[n])??"").length),n.length)*G[0]+G[1]}px`,minWidth:`${(g==null?void 0:g.minWidth)??G[2]}px`,headerClass:"scrollable-header text-center",cellClass:"scrollable-cell text-center"}})]}v.value.data=l.data.map(e=>{const t={};for(const s in e){const u=e[s];t[s]=u==null?u:isNaN(Number(u))?String(u):Number(u)}return o.value.status&&o.value.status.calculate&&(t.status=o.value.status.calculate(e)),t.filterable=!0,t}),x.value=[...v.value.data],setTimeout(H,500)}catch(a){p.value="Failed to fetch data",console.error(a)}finally{k.value=!1,Y()}},fe=async()=>{const a=Object.keys(r.value.dropdowns);for(const l of a){const e=r.value.dropdowns[l].url,t=r.value.dropdowns[l].valueField,s=r.value.dropdowns[l].labelField;try{const u=await M.get(e,{headers:{Authorization:`Bearer ${R.token}`}});v.value.dropdowns[s]=u.data.map(f=>f[t]??"")}catch(u){console.error(`Failed to fetch ${l}:`,u)}}},Y=()=>{const a={};N.value.forEach(l=>{a[l.field]=o.value.checkbox.includes(l.field)?0:""}),a.id=O.value.length+1,O.value.push(a)},$=(a,l)=>{U.value.has(a.id)?U.value.get(a.id)[l]=a[l]:U.value.set(a.id,{...a})},ve=async()=>{var a;try{const l=Array.from(U.value.values());for(const e of l){const t={...e};o.value.toRemove.forEach(s=>delete t[s]),delete t.id,(a=o.value.date)==null||a.forEach(s=>{t[s]&&!isNaN(Date.parse(t[s]))&&(t[s]=new Date(t[s]).toISOString().split("T")[0])}),Object.keys(t).forEach(s=>{t[s]===""&&(t[s]=null)}),await M.post(r.value.data,t,{headers:{Authorization:`Bearer ${R.token}`}})}alert("Data uploaded successfully!"),await S(),O.value=[],U.value.clear()}catch(l){console.error("Upload failed:",l),alert("Upload failed.")}},I=(a,l)=>{C.value.has(a.id)?C.value.get(a.id)[l]=a[l]:C.value.set(a.id,{...a})},me=async()=>{var e;const a=Array.from(C.value.values()),l=[];for(const t of a)try{const s=Object.fromEntries(Object.entries(t).filter(([u])=>{var f;return!((f=o.value.exclude)!=null&&f.includes(u))&&!o.value.toRemove.includes(u)}));(e=o.value.date)==null||e.forEach(u=>{s[u]&&!isNaN(Date.parse(s[u]))&&(s[u]=new Date(s[u]).toISOString().split("T")[0])}),await M.put(r.value.data,s,{headers:{Authorization:`Bearer ${R.token}`}})}catch(s){console.error("Update failed:",s),l.push(t.id)}l.length?alert(`Some rows failed: ${l.join(", ")}`):(alert("All changes saved!"),C.value.clear(),await S())},he=()=>{const a=o.value.priority||[],l=o.value.toRemove||[],e=Object.keys(x.value[0]||{}),t=x.value,s=e.filter(w=>!a.includes(w)&&!l.includes(w)),u=[...a,...s],f=t.map(w=>{const n={};return u.forEach(m=>{n[m]=w[m]}),n}),z=Q.json_to_sheet(f,{header:u}),D=Q.book_new();Q.book_append_sheet(D,z,"Filtered Data"),Ce(D,`${W.value.export||"export"}.xlsx`)},be=a=>{x.value=a,Ue("Filtered data count: "+x.value.length)},Z=a=>{if(!a)return"";const[l,e]=a.split(" ");return`${l}T${e==null?void 0:e.slice(0,5)}`||""},ee=a=>{if(!a)return"";const[l,e]=a.split("T");return`${l} ${e}:00`},we=(a,l,e)=>{l[e]=ee(a.target.value),I(l,e)},ge=(a,l,e)=>{l[e]=ee(a.target.value),$(l,e)},H=()=>{const a=document.querySelector(".vgt-table th:nth-child(1)");if(a){const l=a.offsetWidth;document.documentElement.style.setProperty("--frozen-col-width",`${l}px`)}};return ke(()=>{const a=localStorage.getItem("darkMode");X.value=a==="true",document.documentElement.classList.toggle("dark",X.value),fe(),S(),window.addEventListener("resize",H)}),pe(()=>{window.removeEventListener("resize",H)}),ie({refresh:S}),(a,l)=>(i(),d("div",$e,[V("h2",Ie,B(W.value.title),1),V("div",Ve,[q.value?(i(),E(T,{key:0,onClick:ve,color:"danger",class:"me-2"},{default:_(()=>l[0]||(l[0]=[F("Upload")])),_:1})):b("",!0),q.value?(i(),E(T,{key:1,onClick:Y,color:"secondary"},{default:_(()=>l[1]||(l[1]=[F("Add New Row")])),_:1})):b("",!0)]),k.value?(i(),d("p",Ee,"Loading data...")):b("",!0),p.value?(i(),d("p",Re,B(p.value),1)):b("",!0),!k.value&&!p.value&&q.value?(i(),d("div",Ne,[J(K(ne),{columns:de.value,rows:O.value,"search-options":{enabled:!1},"sort-options":{enabled:!1},"pagination-options":{enabled:!1},style:{"overflow-x":"auto"}},{"table-row":_(e=>[o.value.checkbox.includes(e.column.field)?(i(),d("div",Oe,[V("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,$(e.row,e.column.field)}},null,8,Se)])):Object.keys(v.value.dropdowns).includes(e.column.field)?(i(),E(K(se),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>$(e.row,e.column.field)],options:v.value.dropdowns[e.column.field],searchable:!0,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?A((i(),d("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>$(e.row,e.column.field)},null,40,ze)),[[L,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(i(),d("input",{key:3,type:"datetime-local",value:Z(e.row[e.column.field]),onInput:t=>ge(t,e.row,e.column.field)},null,40,De)):e.column.editable!==!1?A((i(),d("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>$(e.row,e.column.field)},null,40,je)),[[L,e.row[e.column.field]]]):(i(),d("span",Be,B(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])])):b("",!0),V("div",Fe,[J(T,{onClick:he,color:"primary",class:"me-2"},{default:_(()=>l[2]||(l[2]=[F("Export to Excel")])),_:1}),P.value?(i(),E(T,{key:0,onClick:me,color:"success"},{default:_(()=>l[3]||(l[3]=[F("Save Updates")])),_:1})):b("",!0)]),!k.value&&!p.value?(i(),d("div",Te,[J(K(ne),{ref_key:"tableRef",ref:ce,columns:N.value,rows:v.value.data,"search-options":{enabled:!0},"sort-options":{enabled:!0},"pagination-options":{enabled:!0,mode:"pages",perPage:10},style:{"overflow-x":"auto"},onOnFiltered:be},{"table-row":_(e=>[o.value.checkbox.includes(e.column.field)?(i(),d("div",Ae,[V("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:t=>{e.row[e.column.field]=t.target.checked?1:0,I(e.row,e.column.field)}},null,8,Ke)])):Object.keys(v.value.dropdowns).includes(e.column.field)&&P.value?(i(),E(K(se),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[t=>e.row[e.column.field]=t,t=>I(e.row,e.column.field)],options:v.value.dropdowns[e.column.field],searchable:!0,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?A((i(),d("input",{key:2,type:"date","onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>I(e.row,e.column.field)},null,40,Le)),[[L,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(i(),d("input",{key:3,type:"datetime-local",value:Z(e.row[e.column.field]),onInput:t=>we(t,e.row,e.column.field)},null,40,Me)):e.column.editable!==!1?A((i(),d("input",{key:4,"onUpdate:modelValue":t=>e.row[e.column.field]=t,onInput:t=>I(e.row,e.column.field)},null,40,We)),[[L,e.row[e.column.field]]]):(i(),d("span",qe,B(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])])):b("",!0)]))}};export{Ze as _};
