import{u as te,r as c,n as U,o as ae,x as se,c as p,a as t,q as y,t as f,y as ne,z as oe,h as x,d as B,f as E,i as le,s as ie,p as $,A as C,P as re,g as m}from"./index-DtjpuImB.js";const ue={class:""},ce={class:"main-content"},de={class:"app-title"},pe={class:"container-global attendance-card-modern mb-3"},me={class:"status-header"},ve={class:"location-info"},fe={key:0},ge={key:1,class:"text-muted"},he={key:0,class:"alert alert-warning"},_e={class:"attendance-timeline"},we={key:0,class:"timeline-item"},be={class:"timeline-content"},ye={class:"me-2"},ke={key:1,class:"timeline-item"},Me={class:"timeline-content"},Ae={class:"me-2"},De={class:"action-section"},Le={key:0,for:"cameraInput",class:"camera-btn-wrapper"},xe={class:"btn-label"},Se={key:1,class:"success-notice"},$e={key:2,class:"error-text"},Ie={key:3,class:"error-text"},Fe={class:"container-global announcement-card"},Pe={class:"announcement-content"},Ue=["src"],Ce={class:"announcement-text"},Ne={class:"container-global"},Oe={class:"info-card"},ze={class:"info-content"},Te={class:"info-row"},Be={class:"info-value"},Ee={class:"info-row"},Re={class:"info-value"},He={class:"info-row"},Ve={key:0,class:"info-value"},Ge={key:1,class:"info-value text-muted"},Je={class:"info-row"},je={class:"info-value"},qe=["src"],Ye=17,Ke={__name:"AbsensiView",setup(Ze){const d=te();c(null);const r=["Mengambil Data...","Izin Ditolak","Gagal Memuat"],M=c({ipv4:r[0],ipv6:r[0]}),l=c({lat:r[0],lon:r[0]});c({city:r[0],country:r[0],lat:"",lon:""});const S=c(!1),A=c(""),h=c([]),u=c([]),R=c(!0);c(!1);const N=c(""),O=c(null);let k=null;const z=U(()=>![l.value.lat,l.value.lon,M.value.ipv4].some(a=>r.includes(a))),I=U(()=>{var a,e;return(((a=A.value)==null?void 0:a.distance)??99999)>((e=A.value)==null?void 0:e.maxDistance)}),_=U(()=>{const a=u.value[0];if(!a)return"IN";const e=a.hour_in?new Date(a.hour_in):null,s=a.hour_out&&a.hour_out!=="00:00:00"?new Date(a.hour_out):null,o=new Date,i=e&&e.getFullYear()===o.getFullYear()&&e.getMonth()===o.getMonth()&&e.getDate()===o.getDate(),n=e?(o-e)/(1e3*60*60):0,g=s?(o-s)/(1e3*60*60):null;return s&&i||s&&g<2?"DONE":s&&(!i||g>=2)||n>=19?"IN":"OUT"}),D=c({photo:null,description:""}),H=async()=>{try{const a=await $.get(`${C}/tools/memo`);D.value.photo=`${re}/memo/${a.data[0].photo}`,D.value.description=a.data[0].description}catch(a){console.error("Failed to fetch memo:",a)}},V=async()=>{try{const a=await fetch(`${d.apiBaseUrl}/absensi-status?username=${d.username}`);u.value=await a.json(),u.value.length>0&&(u.value[0].foto_in=`${d.baseUrl}/uploads/absensi/${u.value[0].foto_in}`,u.value[0].foto_out=`${d.baseUrl}/uploads/absensi/${u.value[0].foto_out}`)}catch(a){console.error("Failed to fetch absensi status:",a)}finally{R.value=!1}},G=()=>new Promise(a=>{if("geolocation"in navigator)try{navigator.geolocation.getCurrentPosition(e=>{l.value.lat=e.coords.latitude.toFixed(6),l.value.lon=e.coords.longitude.toFixed(6),a(!0)},e=>{console.warn("❌ Geolocation permission denied or error:",e.message),l.value.lat=r[1],l.value.lon=r[1],a(!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0})}catch(e){console.error("❌ Unexpected GPS error:",e),l.value.lat=r[2],l.value.lon=r[2],a(!1)}else l.value.lat=r[2],l.value.lon=r[2],a(!1)});function J(a,e,s,o){const n=(s-a)*Math.PI/180,g=(o-e)*Math.PI/180,v=Math.sin(n/2)**2+Math.cos(a*Math.PI/180)*Math.cos(s*Math.PI/180)*Math.sin(g/2)**2,b=6371*(2*Math.atan2(Math.sqrt(v),Math.sqrt(1-v)))*1e3;return isNaN(b)?0:b.toFixed(2)}const j=async()=>{try{const a=await $.get(`${C}/hr-lokasi`,{headers:{Authorization:`Bearer ${d.token}`}});h.value=a.data.map(e=>{const s=e.latitude??null,o=e.longitude??null,i=e.maxDistance!=null?parseInt(e.maxDistance,10):null,n=s!==null&&o!==null&&l.value.lat&&l.value.lon?J(l.value.lat,l.value.lon,s,o):1/0;return{nama:e.nama??"",lat:s,lon:o,distance:n,maxDistance:i}}),h.value.sort((e,s)=>e.distance-s.distance),h.value.length>0&&(A.value=h.value[0])}catch(a){console.error("Failed to fetch locations:",a)}},q=async()=>{try{const a=await $.get(`${C}/ip`,{headers:{Authorization:`Bearer ${d.token}`}});M.value.ipv4=a.data.ip}catch(a){console.error("Error fetching IP:",a),M.value.ipv4=r[2]}},Y=()=>{const a=`${window.innerWidth}x${window.innerHeight}`,e=navigator.userAgent,s=e.match(/\(([^)]+)\)/);let o=s?s[1]:`?${e}`;return o.length>250&&(o=o.substring(0,250)),{dimension:a,device:o}},Z=a=>new Promise(e=>{const s=new FileReader;s.onload=o=>{const i=new Image;i.onload=()=>{const n=document.createElement("canvas"),g=n.getContext("2d");n.width=600,n.height=800;const v=i.width/i.height;let w,b;v>600/800?(b=800,w=800*v):(w=600,b=600/v);const Q=(600-w)/2,X=(800-b)/2;g.drawImage(i,Q,X,w,b),n.toBlob(ee=>{e(new File([ee],a.name,{type:"image/jpeg",lastModified:Date.now()}))},"image/jpeg",.9)},i.src=o.target.result},s.readAsDataURL(a)}),W=async a=>{const e=a.target.files[0];if(e)try{const s=await Z(e),{dimension:o,device:i}=Y(),n=new FormData;n.append("foto",s),n.append("id",_.value=="IN"?null:u.value[0].id),n.append("status",_.value),n.append("username",d.username),n.append("lokasi",A.value.nama),n.append("jarak",A.value.distance),n.append("long",l.value.lon),n.append("lang",l.value.lat),n.append("ip",M.value.ipv4),n.append("dim",o),n.append("device",i);const v=(await $.post("https://www.transkon-rent.com/api/absensi",n,{headers:{Authorization:`Bearer ${d.token}`,"Content-Type":"multipart/form-data"}})).data;v.status==="success"?(S.value=!0,window.location.reload()):console.error("Attendance failed:",v.message)}catch(s){console.error("Upload error:",s)}},F=c(!1),P=a=>{N.value=a,F.value=!0},K=()=>{F.value=!1};ae(async()=>{try{const a=await G();if(await Promise.all([H(),j(),q(),V()]),a&&l.value.lat&&l.value.lon){const e=parseFloat(l.value.lat),s=parseFloat(l.value.lon);k=L.map(O.value).setView([e,s],Ye),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(k),L.marker([e,s]).addTo(k).bindPopup("Lokasi Anda").openPopup()}window.sendUserToFlutter&&(d!=null&&d.id)&&window.sendUserToFlutter(d.id)}catch(a){console.error("💥 Unhandled error in onMounted:",a)}}),se(()=>{k&&(k.remove(),k=null)});function T(a){const e=["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"],s=new Date(a),o=s.getDate(),i=e[s.getMonth()],n=s.getFullYear(),g=String(s.getHours()).padStart(2,"0"),v=String(s.getMinutes()).padStart(2,"0"),w=String(s.getSeconds()).padStart(2,"0");return`${o} ${i} ${n} ${g}:${v}:${w}`}return(a,e)=>{var o,i;const s=le("VButton");return m(),p("div",ue,[t("main",ce,[t("h1",de,"Hi, "+f(ne(d).name),1),e[24]||(e[24]=t("p",{class:"app-subtitle"},null,-1)),t("div",pe,[t("div",me,[e[4]||(e[4]=t("h3",null,"Absensi Hari Ini",-1)),t("div",{class:oe(["status-badge",`status-${_.value.toLowerCase()}`])},f(_.value==="IN"?"DATANG":_.value==="OUT"?"PULANG":"SELESAI"),3)]),t("div",ve,[e[5]||(e[5]=t("i",{class:"fa-solid fa-location-dot"},null,-1)),h.value.length>0?(m(),p("span",fe,f(h.value[0].nama),1)):(m(),p("span",ge,"Mencari lokasi..."))]),I.value?(m(),p("div",he,e[6]||(e[6]=[t("i",{class:"fa-solid fa-triangle-exclamation"},null,-1),x(" Anda berada di luar zona absensi ")]))):y("",!0),t("div",_e,[(o=u.value[0])!=null&&o.hour_in?(m(),p("div",we,[e[9]||(e[9]=t("div",{class:"timeline-dot success"},null,-1)),t("div",be,[e[8]||(e[8]=t("strong",null,"Absen Datang",-1)),t("small",ye,f(T(u.value[0].hour_in)),1),B(s,{onClick:e[0]||(e[0]=n=>P(u.value[0].foto_in)),size:"sm",class:"mt-1"},{default:E(()=>e[7]||(e[7]=[t("i",{class:"fa-solid fa-image"},null,-1),x(" Lihat Foto ")])),_:1})])])):y("",!0),(i=u.value[0])!=null&&i.hour_out?(m(),p("div",ke,[e[12]||(e[12]=t("div",{class:"timeline-dot warning"},null,-1)),t("div",Me,[e[11]||(e[11]=t("strong",null,"Absen Pulang",-1)),t("small",Ae,f(T(u.value[0].hour_out)),1),B(s,{onClick:e[1]||(e[1]=n=>P(u.value[0].foto_out)),size:"sm",class:"mt-1"},{default:E(()=>e[10]||(e[10]=[t("i",{class:"fa-solid fa-image"},null,-1),x(" Lihat Foto ")])),_:1})])])):y("",!0)]),t("div",De,[t("input",{type:"file",accept:"image/*",capture:"environment",onChange:W,id:"cameraInput",style:{display:"none"}},null,32),!S.value&&z.value&&!I.value&&_.value!=="DONE"?(m(),p("label",Le,[e[13]||(e[13]=t("div",{class:"camera-btn pulse"},[t("i",{class:"fa-solid fa-camera"})],-1)),t("p",xe,f(_.value==="OUT"?"Ambil Foto Pulang":"Ambil Foto Datang"),1)])):y("",!0),S.value?(m(),p("div",Se,e[14]||(e[14]=[t("i",{class:"fa-solid fa-check-circle"},null,-1),t("span",null,"Absensi berhasil direkam!",-1)]))):y("",!0),z.value?I.value&&!S.value?(m(),p("p",Ie,e[16]||(e[16]=[t("i",{class:"fa-solid fa-radar"},null,-1),x(" Di luar jangkauan lokasi absensi ")]))):y("",!0):(m(),p("p",$e,e[15]||(e[15]=[t("i",{class:"fa-solid fa-circle-exclamation"},null,-1),x(" Gagal memuat data lokasi ")])))])]),t("div",Fe,[e[17]||(e[17]=t("div",{class:"announcement-header"},[t("i",{class:"fa-solid fa-bullhorn announcement-icon"}),t("h3",null,"TRJA Memo")],-1)),t("div",Pe,[t("img",{src:D.value.photo,alt:"TRJA Memo",class:"announcement-image",onClick:e[2]||(e[2]=n=>P(D.value.photo)),style:{cursor:"pointer"}},null,8,Ue),t("p",Ce,f(D.value.description),1)])]),t("div",Ne,[t("div",Oe,[e[22]||(e[22]=t("div",{class:"info-header"},[t("i",{class:"fa-solid fa-map-marker-alt"}),t("h4",null,"Lokasi GPS Anda")],-1)),t("div",ze,[t("div",Te,[e[18]||(e[18]=t("span",{class:"info-label"},"Latitude:",-1)),t("span",Be,f(l.value.lat),1)]),t("div",Ee,[e[19]||(e[19]=t("span",{class:"info-label"},"Longitude:",-1)),t("span",Re,f(l.value.lon),1)]),t("div",He,[e[20]||(e[20]=t("span",{class:"info-label"},"Jarak:",-1)),h.value.length>0?(m(),p("span",Ve,f(h.value[0].distance+" Meter"),1)):(m(),p("span",Ge," Menghitung Jarak.. "))]),t("div",Je,[e[21]||(e[21]=t("span",{class:"info-label"},"IPv4:",-1)),t("span",je,f(M.value.ipv4),1)]),t("div",{ref_key:"gpsMapContainer",ref:O,class:"map-container-leaflet"},null,512)])]),e[23]||(e[23]=t("p",null,[t("span",{style:{color:"red","font-size":"10px"}}," *Segala bentuk kecurangan pencatatan kehadiran dapat terdeteksi dan akan ditindaklanjuti ")],-1))]),F.value?(m(),p("div",{key:0,class:"memo-overlay",onClick:K},[t("img",{src:N.value,onClick:e[3]||(e[3]=ie(()=>{},["stop"]))},null,8,qe)])):y("",!0)])])}}};export{Ke as default};
