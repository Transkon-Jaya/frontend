import{u as we,r as d,n as ge,o as ye,J as _e,c as i,g as u,a as V,q as b,t as D,K as N,f as y,h as j,V as B,d as H,b as T,y as A,v as F,p as K}from"./index-g6npIRNv.js";import{V as ne}from"./vue-good-table.esm-DcmEr__N.js";/* empty css                            */import{s as se}from"./vue-multiselect-D9Qbj3c4.js";import{u as J,w as xe}from"./xlsx-D1NZSDnX.js";import{a as ke}from"./logger-DsocdAuK.js";/* empty css                                                 */const Ce={class:"container-global mb-4"},Ue={class:"table-title"},pe={class:"table-actions mb-3"},$e={key:0},Ie={key:1,class:"error"},Ve={key:2,class:"table-container insert-table"},Ne={key:0,class:"checkbox-container"},Se=["checked","onClick"],Ee=["onUpdate:modelValue","onInput"],Oe=["value","onInput"],Re=["onUpdate:modelValue","onInput"],ze={key:5},De={class:"table-actions mb-3"},je={key:3,class:"table-container main-table"},Be={key:0,class:"checkbox-container"},Te=["checked","onClick"],Ae=["onUpdate:modelValue","onInput"],Fe=["value","onInput"],Ke=["onUpdate:modelValue","onInput"],Le={key:5},Qe={__name:"BigTable",props:{settings:{type:Object,required:!0},urls:{type:Object,required:!0},fields:{type:Object,required:!0},canInsert:{type:Boolean,default:!0},canUpdate:{type:Boolean,default:!0}},setup(ue){const S=we(),Q=d(!1),_=ue,L=d(_.settings),r=d(_.urls),o=d(_.fields),M=d(_.canInsert),q=d(_.canUpdate),W=L.value.size??[10,20,100];Array.isArray(o.value.toRemove)?o.value.toRemove.push("isEditing","filterable","vgt_id","originalIndex"):o.value.toRemove=["isEditing","filterable","vgt_id","originalIndex"];const v=d({data:[],dropdowns:[]}),E=d([]),ce=ge(()=>E.value.map(t=>({...t,filterOptions:{enabled:!1},sortable:!1}))),O=d([]),x=d([]),k=d(!0),C=d(null),U=d(new Map),p=d(new Map);let X=r.value.data;if(r.value.params){const t=new URLSearchParams(r.value.params).toString();X+=`?${t}`}const ie=async()=>{const t=Object.keys(r.value.dropdowns);for(const l of t){const e=r.value.dropdowns[l].url,a=r.value.dropdowns[l].valueField,n=r.value.dropdowns[l].labelField;try{const c=await K.get(e,{headers:{Authorization:`Bearer ${S.token}`}});v.value.dropdowns[n]=c.data.map(f=>f[a]??"")}catch(c){console.error(`Failed to fetch ${l}:`,c)}}},P=async()=>{try{k.value=!0;const t=await K.get(X,{headers:{Authorization:`Bearer ${S.token}`}});if(t.data.length>0){const l=o.value.priority||[],e=o.value.toRemove||[],a=o.value.unpriority||[],n=Object.keys(t.data[0]),c=l.filter(s=>n.includes(s)&&s!==o.value.firstCol.field&&!e.includes(s)&&!a.includes(s)),f=a.filter(s=>n.includes(s)&&s!==o.value.firstCol.field&&!e.includes(s)&&!c.includes(s)),R=n.filter(s=>{var m;return!c.includes(s)&&!f.includes(s)&&s!==o.value.firstCol.field&&!e.includes(s)&&!((m=o.value.hidden)!=null&&m.includes(s))}),w=[...c,...R,...f];E.value=[{label:o.value.firstCol.label,field:o.value.firstCol.field,width:`${o.value.firstCol.width??150}px`,minWidth:"150px",sortable:!0,filterable:!1,editable:!1,type:o.value.firstCol.type,headerClass:"frozen-col text-center",cellClass:"frozen-cell text-center"},...o.value.status?[{label:o.value.status.label??o.value.status.field.toUpperCase(),field:o.value.status.field,width:`${o.value.status.width??120}px`,minWidth:"120px",sortable:!1,filterable:!0,editable:!1,type:"text",headerClass:"frozen-col status-col text-center",cellClass:"frozen-cell status-cell text-center"}]:[],...w.map(s=>{var te,le,ae,z,oe;const m=o.value.checkbox.includes(s),be=!m&&t.data.every(h=>!isNaN(Number(h[s]))),g=(le=(te=o.value)==null?void 0:te.columns)==null?void 0:le.find(h=>h.column===s);return{label:s.replace(/_/g," ").toUpperCase(),field:s,sortable:!0,filterable:!0,filterOptions:{enabled:!0,placeholder:s},editable:q.value&&!((oe=(z=(ae=o.value)==null?void 0:ae.uneditable)==null?void 0:z.includes)!=null&&oe.call(z,s)),type:m?"checkbox":be?"number":"text",width:`${(g==null?void 0:g.width)??Math.max(...t.data.map(h=>String((h==null?void 0:h[s])??"").length),s.length)*W[0]+W[1]}px`,minWidth:`${(g==null?void 0:g.minWidth)??W[2]}px`,headerClass:"scrollable-header text-center",cellClass:"scrollable-cell text-center"}})]}v.value.data=t.data.map(l=>{const e={};for(const a in l){const n=l[a];e[a]=n==null?n:isNaN(Number(n))?String(n):Number(n)}return o.value.status&&o.value.status.calculate&&(e.status=o.value.status.calculate(l)),e.filterable=!0,e}),x.value=[...v.value.data],setTimeout(G,500)}catch(t){C.value="Failed to fetch data",console.error(t)}finally{k.value=!1,Y()}},Y=()=>{const t={};E.value.forEach(l=>{t[l.field]=o.value.checkbox.includes(l.field)?0:""}),t.id=O.value.length+1,O.value.push(t)},$=(t,l)=>{p.value.has(t.id)?p.value.get(t.id)[l]=t[l]:p.value.set(t.id,{...t})},de=async()=>{var t;try{const l=Array.from(p.value.values());for(const e of l){const a={...e};o.value.toRemove.forEach(n=>delete a[n]),delete a.id,(t=o.value.date)==null||t.forEach(n=>{a[n]&&!isNaN(Date.parse(a[n]))&&(a[n]=new Date(a[n]).toISOString().split("T")[0])}),Object.keys(a).forEach(n=>{a[n]===""&&(a[n]=null)}),await K.post(r.value.data,a,{headers:{Authorization:`Bearer ${S.token}`}})}alert("Data uploaded successfully!"),await P(),O.value=[],p.value.clear()}catch(l){console.error("Upload failed:",l),alert("Upload failed.")}},I=(t,l)=>{U.value.has(t.id)?U.value.get(t.id)[l]=t[l]:U.value.set(t.id,{...t})},re=async()=>{var e;const t=Array.from(U.value.values()),l=[];for(const a of t)try{const n=Object.fromEntries(Object.entries(a).filter(([c])=>{var f;return!((f=o.value.exclude)!=null&&f.includes(c))&&!o.value.toRemove.includes(c)}));(e=o.value.date)==null||e.forEach(c=>{n[c]&&!isNaN(Date.parse(n[c]))&&(n[c]=new Date(n[c]).toISOString().split("T")[0])}),await K.put(r.value.data,n,{headers:{Authorization:`Bearer ${S.token}`}})}catch(n){console.error("Update failed:",n),l.push(a.id)}l.length?alert(`Some rows failed: ${l.join(", ")}`):(alert("All changes saved!"),U.value.clear(),await P())},fe=()=>{const t=o.value.priority||[],l=o.value.toRemove||[],a=Object.keys(x.value[0]).filter(w=>!t.includes(w)&&!l.includes(w)),n=[...t,...a],c=x.value.map(w=>{const s={};return n.forEach(m=>{s[m]=w[m]}),s}),f=J.json_to_sheet(c,{header:n}),R=J.book_new();J.book_append_sheet(R,f,"Data"),xe(R,`${L.value.export||"export"}.xlsx`)},ve=t=>{x.value=t,ke("Filtered data count: "+x.value.length)},Z=t=>{if(!t)return"";const[l,e]=t.split(" ");return`${l}T${e==null?void 0:e.slice(0,5)}`||""},ee=t=>{if(!t)return"";const[l,e]=t.split("T");return`${l} ${e}:00`},me=(t,l,e)=>{l[e]=ee(t.target.value),I(l,e)},he=(t,l,e)=>{l[e]=ee(t.target.value),$(l,e)},G=()=>{const t=document.querySelector(".vgt-table th:nth-child(1)");if(t){const l=t.offsetWidth;document.documentElement.style.setProperty("--frozen-col-width",`${l}px`)}};return ye(()=>{const t=localStorage.getItem("darkMode");Q.value=t==="true",document.documentElement.classList.toggle("dark",Q.value),ie(),P(),window.addEventListener("resize",G)}),_e(()=>{window.removeEventListener("resize",G)}),(t,l)=>(u(),i("div",Ce,[V("h2",Ue,D(L.value.title),1),V("div",pe,[M.value?(u(),N(B,{key:0,onClick:de,color:"danger",class:"me-2"},{default:y(()=>l[0]||(l[0]=[j("Upload")])),_:1})):b("",!0),M.value?(u(),N(B,{key:1,onClick:Y,color:"secondary"},{default:y(()=>l[1]||(l[1]=[j("Add New Row")])),_:1})):b("",!0)]),k.value?(u(),i("p",$e,"Loading data...")):b("",!0),C.value?(u(),i("p",Ie,D(C.value),1)):b("",!0),!k.value&&!C.value&&M.value?(u(),i("div",Ve,[H(A(ne),{columns:ce.value,rows:O.value,"search-options":{enabled:!1},"sort-options":{enabled:!1},"pagination-options":{enabled:!1},style:{"overflow-x":"auto"}},{"table-row":y(e=>[o.value.checkbox.includes(e.column.field)?(u(),i("div",Ne,[V("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:a=>{e.row[e.column.field]=a.target.checked?1:0,$(e.row,e.column.field)}},null,8,Se)])):Object.keys(v.value.dropdowns).includes(e.column.field)?(u(),N(A(se),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[a=>e.row[e.column.field]=a,a=>$(e.row,e.column.field)],options:v.value.dropdowns[e.column.field],searchable:!0,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?T((u(),i("input",{key:2,type:"date","onUpdate:modelValue":a=>e.row[e.column.field]=a,onInput:a=>$(e.row,e.column.field)},null,40,Ee)),[[F,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(u(),i("input",{key:3,type:"datetime-local",value:Z(e.row[e.column.field]),onInput:a=>he(a,e.row,e.column.field)},null,40,Oe)):e.column.editable!==!1?T((u(),i("input",{key:4,"onUpdate:modelValue":a=>e.row[e.column.field]=a,onInput:a=>$(e.row,e.column.field)},null,40,Re)),[[F,e.row[e.column.field]]]):(u(),i("span",ze,D(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])])):b("",!0),V("div",De,[H(B,{onClick:fe,color:"primary",class:"me-2"},{default:y(()=>l[2]||(l[2]=[j("Export to Excel")])),_:1}),q.value?(u(),N(B,{key:0,onClick:re,color:"success"},{default:y(()=>l[3]||(l[3]=[j("Save Updates")])),_:1})):b("",!0)]),!k.value&&!C.value?(u(),i("div",je,[H(A(ne),{columns:E.value,rows:v.value.data,"search-options":{enabled:!0},"sort-options":{enabled:!0},"pagination-options":{enabled:!0,mode:"pages",perPage:10},style:{"overflow-x":"auto"},onOnFiltered:ve},{"table-row":y(e=>[o.value.checkbox.includes(e.column.field)?(u(),i("div",Be,[V("input",{type:"checkbox",class:"custom-checkbox",checked:e.row[e.column.field]==1,onClick:a=>{e.row[e.column.field]=a.target.checked?1:0,I(e.row,e.column.field)}},null,8,Te)])):Object.keys(v.value.dropdowns).includes(e.column.field)&&q.value?(u(),N(A(se),{key:1,modelValue:e.row[e.column.field],"onUpdate:modelValue":[a=>e.row[e.column.field]=a,a=>I(e.row,e.column.field)],options:v.value.dropdowns[e.column.field],searchable:!0,placeholder:`Select ${e.column.field}`},null,8,["modelValue","onUpdate:modelValue","options","placeholder"])):o.value.date.includes(e.column.field)?T((u(),i("input",{key:2,type:"date","onUpdate:modelValue":a=>e.row[e.column.field]=a,onInput:a=>I(e.row,e.column.field)},null,40,Ae)),[[F,e.row[e.column.field]]]):o.value.datetime.includes(e.column.field)?(u(),i("input",{key:3,type:"datetime-local",value:Z(e.row[e.column.field]),onInput:a=>me(a,e.row,e.column.field)},null,40,Fe)):e.column.editable!==!1?T((u(),i("input",{key:4,"onUpdate:modelValue":a=>e.row[e.column.field]=a,onInput:a=>I(e.row,e.column.field)},null,40,Ke)),[[F,e.row[e.column.field]]]):(u(),i("span",Le,D(e.row[e.column.field]),1))]),_:1},8,["columns","rows"])])):b("",!0)]))}};export{Qe as _};
